{"remainingRequest":"/home/coding/workspace/node_modules/ts-loader/index.js?{\"happyPackMode\":true,\"compilerOptions\":{\"target\":\"es5\",\"lib\":[\"dom\",\"esnext\"]}}!/home/coding/workspace/lib/vscode/src/vs/editor/contrib/colorPicker/colorDetector.ts","dependencies":[{"path":"/home/coding/workspace/lib/vscode/src/vs/editor/contrib/colorPicker/colorDetector.ts","mtime":1555102316000},{"path":"/home/coding/workspace/node_modules/cache-loader/dist/cjs.js","mtime":1555844183884},{"path":"/home/coding/workspace/node_modules/ts-loader/index.js","mtime":1555844217316}],"contextDependencies":[],"result":["\"use strict\";\n/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar tslib_1 = require(\"tslib\");\nvar async_1 = require(\"vs/base/common/async\");\nvar color_1 = require(\"vs/base/common/color\");\nvar errors_1 = require(\"vs/base/common/errors\");\nvar hash_1 = require(\"vs/base/common/hash\");\nvar lifecycle_1 = require(\"vs/base/common/lifecycle\");\nvar editorExtensions_1 = require(\"vs/editor/browser/editorExtensions\");\nvar codeEditorService_1 = require(\"vs/editor/browser/services/codeEditorService\");\nvar range_1 = require(\"vs/editor/common/core/range\");\nvar textModel_1 = require(\"vs/editor/common/model/textModel\");\nvar modes_1 = require(\"vs/editor/common/modes\");\nvar color_2 = require(\"vs/editor/contrib/colorPicker/color\");\nvar configuration_1 = require(\"vs/platform/configuration/common/configuration\");\nvar MAX_DECORATORS = 500;\nvar ColorDetector = /** @class */ (function () {\n    function ColorDetector(_editor, _codeEditorService, _configurationService) {\n        var _this = this;\n        this._editor = _editor;\n        this._codeEditorService = _codeEditorService;\n        this._configurationService = _configurationService;\n        this._globalToDispose = [];\n        this._localToDispose = [];\n        this._decorationsIds = [];\n        this._colorDatas = new Map();\n        this._colorDecoratorIds = [];\n        this._decorationsTypes = {};\n        this._globalToDispose.push(_editor.onDidChangeModel(function (e) {\n            _this._isEnabled = _this.isEnabled();\n            _this.onModelChanged();\n        }));\n        this._globalToDispose.push(_editor.onDidChangeModelLanguage(function (e) { return _this.onModelChanged(); }));\n        this._globalToDispose.push(modes_1.ColorProviderRegistry.onDidChange(function (e) { return _this.onModelChanged(); }));\n        this._globalToDispose.push(_editor.onDidChangeConfiguration(function (e) {\n            var prevIsEnabled = _this._isEnabled;\n            _this._isEnabled = _this.isEnabled();\n            if (prevIsEnabled !== _this._isEnabled) {\n                if (_this._isEnabled) {\n                    _this.onModelChanged();\n                }\n                else {\n                    _this.removeAllDecorations();\n                }\n            }\n        }));\n        this._timeoutTimer = null;\n        this._computePromise = null;\n        this._isEnabled = this.isEnabled();\n        this.onModelChanged();\n    }\n    ColorDetector.prototype.isEnabled = function () {\n        var model = this._editor.getModel();\n        if (!model) {\n            return false;\n        }\n        var languageId = model.getLanguageIdentifier();\n        // handle deprecated settings. [languageId].colorDecorators.enable\n        var deprecatedConfig = this._configurationService.getValue(languageId.language);\n        if (deprecatedConfig) {\n            var colorDecorators = deprecatedConfig['colorDecorators']; // deprecatedConfig.valueOf('.colorDecorators.enable');\n            if (colorDecorators && colorDecorators['enable'] !== undefined && !colorDecorators['enable']) {\n                return colorDecorators['enable'];\n            }\n        }\n        return this._editor.getConfiguration().contribInfo.colorDecorators;\n    };\n    ColorDetector.prototype.getId = function () {\n        return ColorDetector.ID;\n    };\n    ColorDetector.get = function (editor) {\n        return editor.getContribution(this.ID);\n    };\n    ColorDetector.prototype.dispose = function () {\n        this.stop();\n        this.removeAllDecorations();\n        this._globalToDispose = lifecycle_1.dispose(this._globalToDispose);\n    };\n    ColorDetector.prototype.onModelChanged = function () {\n        var _this = this;\n        this.stop();\n        if (!this._isEnabled) {\n            return;\n        }\n        var model = this._editor.getModel();\n        if (!model || !modes_1.ColorProviderRegistry.has(model)) {\n            return;\n        }\n        this._localToDispose.push(this._editor.onDidChangeModelContent(function (e) {\n            if (!_this._timeoutTimer) {\n                _this._timeoutTimer = new async_1.TimeoutTimer();\n                _this._timeoutTimer.cancelAndSet(function () {\n                    _this._timeoutTimer = null;\n                    _this.beginCompute();\n                }, ColorDetector.RECOMPUTE_TIME);\n            }\n        }));\n        this.beginCompute();\n    };\n    ColorDetector.prototype.beginCompute = function () {\n        var _this = this;\n        this._computePromise = async_1.createCancelablePromise(function (token) {\n            var model = _this._editor.getModel();\n            if (!model) {\n                return Promise.resolve([]);\n            }\n            return color_2.getColors(model, token);\n        });\n        this._computePromise.then(function (colorInfos) {\n            _this.updateDecorations(colorInfos);\n            _this.updateColorDecorators(colorInfos);\n            _this._computePromise = null;\n        }, errors_1.onUnexpectedError);\n    };\n    ColorDetector.prototype.stop = function () {\n        if (this._timeoutTimer) {\n            this._timeoutTimer.cancel();\n            this._timeoutTimer = null;\n        }\n        if (this._computePromise) {\n            this._computePromise.cancel();\n            this._computePromise = null;\n        }\n        this._localToDispose = lifecycle_1.dispose(this._localToDispose);\n    };\n    ColorDetector.prototype.updateDecorations = function (colorDatas) {\n        var _this = this;\n        var decorations = colorDatas.map(function (c) { return ({\n            range: {\n                startLineNumber: c.colorInfo.range.startLineNumber,\n                startColumn: c.colorInfo.range.startColumn,\n                endLineNumber: c.colorInfo.range.endLineNumber,\n                endColumn: c.colorInfo.range.endColumn\n            },\n            options: textModel_1.ModelDecorationOptions.EMPTY\n        }); });\n        this._decorationsIds = this._editor.deltaDecorations(this._decorationsIds, decorations);\n        this._colorDatas = new Map();\n        this._decorationsIds.forEach(function (id, i) { return _this._colorDatas.set(id, colorDatas[i]); });\n    };\n    ColorDetector.prototype.updateColorDecorators = function (colorData) {\n        var decorations = [];\n        var newDecorationsTypes = {};\n        for (var i = 0; i < colorData.length && decorations.length < MAX_DECORATORS; i++) {\n            var _a = colorData[i].colorInfo.color, red = _a.red, green = _a.green, blue = _a.blue, alpha = _a.alpha;\n            var rgba = new color_1.RGBA(Math.round(red * 255), Math.round(green * 255), Math.round(blue * 255), alpha);\n            var subKey = hash_1.hash(rgba).toString(16);\n            var color = \"rgba(\" + rgba.r + \", \" + rgba.g + \", \" + rgba.b + \", \" + rgba.a + \")\";\n            var key = 'colorBox-' + subKey;\n            if (!this._decorationsTypes[key] && !newDecorationsTypes[key]) {\n                this._codeEditorService.registerDecorationType(key, {\n                    before: {\n                        contentText: ' ',\n                        border: 'solid 0.1em #000',\n                        margin: '0.1em 0.2em 0 0.2em',\n                        width: '0.8em',\n                        height: '0.8em',\n                        backgroundColor: color\n                    },\n                    dark: {\n                        before: {\n                            border: 'solid 0.1em #eee'\n                        }\n                    }\n                });\n            }\n            newDecorationsTypes[key] = true;\n            decorations.push({\n                range: {\n                    startLineNumber: colorData[i].colorInfo.range.startLineNumber,\n                    startColumn: colorData[i].colorInfo.range.startColumn,\n                    endLineNumber: colorData[i].colorInfo.range.endLineNumber,\n                    endColumn: colorData[i].colorInfo.range.endColumn\n                },\n                options: this._codeEditorService.resolveDecorationOptions(key, true)\n            });\n        }\n        for (var subType in this._decorationsTypes) {\n            if (!newDecorationsTypes[subType]) {\n                this._codeEditorService.removeDecorationType(subType);\n            }\n        }\n        this._colorDecoratorIds = this._editor.deltaDecorations(this._colorDecoratorIds, decorations);\n    };\n    ColorDetector.prototype.removeAllDecorations = function () {\n        this._decorationsIds = this._editor.deltaDecorations(this._decorationsIds, []);\n        this._colorDecoratorIds = this._editor.deltaDecorations(this._colorDecoratorIds, []);\n        for (var subType in this._decorationsTypes) {\n            this._codeEditorService.removeDecorationType(subType);\n        }\n    };\n    ColorDetector.prototype.getColorData = function (position) {\n        var _this = this;\n        var model = this._editor.getModel();\n        if (!model) {\n            return null;\n        }\n        var decorations = model\n            .getDecorationsInRange(range_1.Range.fromPositions(position, position))\n            .filter(function (d) { return _this._colorDatas.has(d.id); });\n        if (decorations.length === 0) {\n            return null;\n        }\n        return this._colorDatas.get(decorations[0].id);\n    };\n    ColorDetector.ID = 'editor.contrib.colorDetector';\n    ColorDetector.RECOMPUTE_TIME = 1000; // ms\n    ColorDetector = tslib_1.__decorate([\n        tslib_1.__param(1, codeEditorService_1.ICodeEditorService),\n        tslib_1.__param(2, configuration_1.IConfigurationService)\n    ], ColorDetector);\n    return ColorDetector;\n}());\nexports.ColorDetector = ColorDetector;\neditorExtensions_1.registerEditorContribution(ColorDetector);\n",{"version":3,"file":"/home/coding/workspace/lib/vscode/src/vs/editor/contrib/colorPicker/colorDetector.ts","sourceRoot":"","sources":["/home/coding/workspace/lib/vscode/src/vs/editor/contrib/colorPicker/colorDetector.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancelablePromise, TimeoutTimer, createCancelablePromise } from 'vs/base/common/async';\nimport { RGBA } from 'vs/base/common/color';\nimport { onUnexpectedError } from 'vs/base/common/errors';\nimport { hash } from 'vs/base/common/hash';\nimport { IDisposable, dispose } from 'vs/base/common/lifecycle';\nimport { ICodeEditor } from 'vs/editor/browser/editorBrowser';\nimport { registerEditorContribution } from 'vs/editor/browser/editorExtensions';\nimport { ICodeEditorService } from 'vs/editor/browser/services/codeEditorService';\nimport { Position } from 'vs/editor/common/core/position';\nimport { Range } from 'vs/editor/common/core/range';\nimport { IEditorContribution } from 'vs/editor/common/editorCommon';\nimport { IModelDeltaDecoration } from 'vs/editor/common/model';\nimport { ModelDecorationOptions } from 'vs/editor/common/model/textModel';\nimport { ColorProviderRegistry } from 'vs/editor/common/modes';\nimport { IColorData, getColors } from 'vs/editor/contrib/colorPicker/color';\nimport { IConfigurationService } from 'vs/platform/configuration/common/configuration';\n\nconst MAX_DECORATORS = 500;\n\nexport class ColorDetector implements IEditorContribution {\n\n\tprivate static readonly ID: string = 'editor.contrib.colorDetector';\n\n\tstatic RECOMPUTE_TIME = 1000; // ms\n\n\tprivate _globalToDispose: IDisposable[] = [];\n\tprivate _localToDispose: IDisposable[] = [];\n\tprivate _computePromise: CancelablePromise<IColorData[]> | null;\n\tprivate _timeoutTimer: TimeoutTimer | null;\n\n\tprivate _decorationsIds: string[] = [];\n\tprivate _colorDatas = new Map<string, IColorData>();\n\n\tprivate _colorDecoratorIds: string[] = [];\n\tprivate readonly _decorationsTypes: { [key: string]: boolean } = {};\n\n\tprivate _isEnabled: boolean;\n\n\tconstructor(private readonly _editor: ICodeEditor,\n\t\t@ICodeEditorService private readonly _codeEditorService: ICodeEditorService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService\n\t) {\n\t\tthis._globalToDispose.push(_editor.onDidChangeModel((e) => {\n\t\t\tthis._isEnabled = this.isEnabled();\n\t\t\tthis.onModelChanged();\n\t\t}));\n\t\tthis._globalToDispose.push(_editor.onDidChangeModelLanguage((e) => this.onModelChanged()));\n\t\tthis._globalToDispose.push(ColorProviderRegistry.onDidChange((e) => this.onModelChanged()));\n\t\tthis._globalToDispose.push(_editor.onDidChangeConfiguration((e) => {\n\t\t\tlet prevIsEnabled = this._isEnabled;\n\t\t\tthis._isEnabled = this.isEnabled();\n\t\t\tif (prevIsEnabled !== this._isEnabled) {\n\t\t\t\tif (this._isEnabled) {\n\t\t\t\t\tthis.onModelChanged();\n\t\t\t\t} else {\n\t\t\t\t\tthis.removeAllDecorations();\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tthis._timeoutTimer = null;\n\t\tthis._computePromise = null;\n\t\tthis._isEnabled = this.isEnabled();\n\t\tthis.onModelChanged();\n\t}\n\n\tisEnabled(): boolean {\n\t\tconst model = this._editor.getModel();\n\t\tif (!model) {\n\t\t\treturn false;\n\t\t}\n\t\tconst languageId = model.getLanguageIdentifier();\n\t\t// handle deprecated settings. [languageId].colorDecorators.enable\n\t\tlet deprecatedConfig = this._configurationService.getValue(languageId.language);\n\t\tif (deprecatedConfig) {\n\t\t\tlet colorDecorators = deprecatedConfig['colorDecorators']; // deprecatedConfig.valueOf('.colorDecorators.enable');\n\t\t\tif (colorDecorators && colorDecorators['enable'] !== undefined && !colorDecorators['enable']) {\n\t\t\t\treturn colorDecorators['enable'];\n\t\t\t}\n\t\t}\n\n\t\treturn this._editor.getConfiguration().contribInfo.colorDecorators;\n\t}\n\n\tgetId(): string {\n\t\treturn ColorDetector.ID;\n\t}\n\n\tstatic get(editor: ICodeEditor): ColorDetector {\n\t\treturn editor.getContribution<ColorDetector>(this.ID);\n\t}\n\n\tdispose(): void {\n\t\tthis.stop();\n\t\tthis.removeAllDecorations();\n\t\tthis._globalToDispose = dispose(this._globalToDispose);\n\t}\n\n\tprivate onModelChanged(): void {\n\t\tthis.stop();\n\n\t\tif (!this._isEnabled) {\n\t\t\treturn;\n\t\t}\n\t\tconst model = this._editor.getModel();\n\n\t\tif (!model || !ColorProviderRegistry.has(model)) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._localToDispose.push(this._editor.onDidChangeModelContent((e) => {\n\t\t\tif (!this._timeoutTimer) {\n\t\t\t\tthis._timeoutTimer = new TimeoutTimer();\n\t\t\t\tthis._timeoutTimer.cancelAndSet(() => {\n\t\t\t\t\tthis._timeoutTimer = null;\n\t\t\t\t\tthis.beginCompute();\n\t\t\t\t}, ColorDetector.RECOMPUTE_TIME);\n\t\t\t}\n\t\t}));\n\t\tthis.beginCompute();\n\t}\n\n\tprivate beginCompute(): void {\n\t\tthis._computePromise = createCancelablePromise(token => {\n\t\t\tconst model = this._editor.getModel();\n\t\t\tif (!model) {\n\t\t\t\treturn Promise.resolve([]);\n\t\t\t}\n\t\t\treturn getColors(model, token);\n\t\t});\n\t\tthis._computePromise.then((colorInfos) => {\n\t\t\tthis.updateDecorations(colorInfos);\n\t\t\tthis.updateColorDecorators(colorInfos);\n\t\t\tthis._computePromise = null;\n\t\t}, onUnexpectedError);\n\t}\n\n\tprivate stop(): void {\n\t\tif (this._timeoutTimer) {\n\t\t\tthis._timeoutTimer.cancel();\n\t\t\tthis._timeoutTimer = null;\n\t\t}\n\t\tif (this._computePromise) {\n\t\t\tthis._computePromise.cancel();\n\t\t\tthis._computePromise = null;\n\t\t}\n\t\tthis._localToDispose = dispose(this._localToDispose);\n\t}\n\n\tprivate updateDecorations(colorDatas: IColorData[]): void {\n\t\tconst decorations = colorDatas.map(c => ({\n\t\t\trange: {\n\t\t\t\tstartLineNumber: c.colorInfo.range.startLineNumber,\n\t\t\t\tstartColumn: c.colorInfo.range.startColumn,\n\t\t\t\tendLineNumber: c.colorInfo.range.endLineNumber,\n\t\t\t\tendColumn: c.colorInfo.range.endColumn\n\t\t\t},\n\t\t\toptions: ModelDecorationOptions.EMPTY\n\t\t}));\n\n\t\tthis._decorationsIds = this._editor.deltaDecorations(this._decorationsIds, decorations);\n\n\t\tthis._colorDatas = new Map<string, IColorData>();\n\t\tthis._decorationsIds.forEach((id, i) => this._colorDatas.set(id, colorDatas[i]));\n\t}\n\n\tprivate updateColorDecorators(colorData: IColorData[]): void {\n\t\tlet decorations: IModelDeltaDecoration[] = [];\n\t\tlet newDecorationsTypes: { [key: string]: boolean } = {};\n\n\t\tfor (let i = 0; i < colorData.length && decorations.length < MAX_DECORATORS; i++) {\n\t\t\tconst { red, green, blue, alpha } = colorData[i].colorInfo.color;\n\t\t\tconst rgba = new RGBA(Math.round(red * 255), Math.round(green * 255), Math.round(blue * 255), alpha);\n\t\t\tlet subKey = hash(rgba).toString(16);\n\t\t\tlet color = `rgba(${rgba.r}, ${rgba.g}, ${rgba.b}, ${rgba.a})`;\n\t\t\tlet key = 'colorBox-' + subKey;\n\n\t\t\tif (!this._decorationsTypes[key] && !newDecorationsTypes[key]) {\n\t\t\t\tthis._codeEditorService.registerDecorationType(key, {\n\t\t\t\t\tbefore: {\n\t\t\t\t\t\tcontentText: ' ',\n\t\t\t\t\t\tborder: 'solid 0.1em #000',\n\t\t\t\t\t\tmargin: '0.1em 0.2em 0 0.2em',\n\t\t\t\t\t\twidth: '0.8em',\n\t\t\t\t\t\theight: '0.8em',\n\t\t\t\t\t\tbackgroundColor: color\n\t\t\t\t\t},\n\t\t\t\t\tdark: {\n\t\t\t\t\t\tbefore: {\n\t\t\t\t\t\t\tborder: 'solid 0.1em #eee'\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tnewDecorationsTypes[key] = true;\n\t\t\tdecorations.push({\n\t\t\t\trange: {\n\t\t\t\t\tstartLineNumber: colorData[i].colorInfo.range.startLineNumber,\n\t\t\t\t\tstartColumn: colorData[i].colorInfo.range.startColumn,\n\t\t\t\t\tendLineNumber: colorData[i].colorInfo.range.endLineNumber,\n\t\t\t\t\tendColumn: colorData[i].colorInfo.range.endColumn\n\t\t\t\t},\n\t\t\t\toptions: this._codeEditorService.resolveDecorationOptions(key, true)\n\t\t\t});\n\t\t}\n\n\t\tfor (let subType in this._decorationsTypes) {\n\t\t\tif (!newDecorationsTypes[subType]) {\n\t\t\t\tthis._codeEditorService.removeDecorationType(subType);\n\t\t\t}\n\t\t}\n\n\t\tthis._colorDecoratorIds = this._editor.deltaDecorations(this._colorDecoratorIds, decorations);\n\t}\n\n\tprivate removeAllDecorations(): void {\n\t\tthis._decorationsIds = this._editor.deltaDecorations(this._decorationsIds, []);\n\t\tthis._colorDecoratorIds = this._editor.deltaDecorations(this._colorDecoratorIds, []);\n\n\t\tfor (let subType in this._decorationsTypes) {\n\t\t\tthis._codeEditorService.removeDecorationType(subType);\n\t\t}\n\t}\n\n\tgetColorData(position: Position): IColorData | null {\n\t\tconst model = this._editor.getModel();\n\t\tif (!model) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst decorations = model\n\t\t\t.getDecorationsInRange(Range.fromPositions(position, position))\n\t\t\t.filter(d => this._colorDatas.has(d.id));\n\n\t\tif (decorations.length === 0) {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn this._colorDatas.get(decorations[0].id)!;\n\t}\n}\n\nregisterEditorContribution(ColorDetector);\n"]}]}