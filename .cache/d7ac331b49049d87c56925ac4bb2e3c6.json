{"remainingRequest":"/home/coding/workspace/node_modules/ts-loader/index.js?{\"happyPackMode\":true,\"compilerOptions\":{\"target\":\"es5\",\"lib\":[\"dom\",\"esnext\"]}}!/home/coding/workspace/lib/vscode/src/vs/workbench/contrib/search/common/searchModel.ts","dependencies":[{"path":"/home/coding/workspace/lib/vscode/src/vs/workbench/contrib/search/common/searchModel.ts","mtime":1555102317000},{"path":"/home/coding/workspace/node_modules/cache-loader/dist/cjs.js","mtime":1555844183884},{"path":"/home/coding/workspace/node_modules/ts-loader/index.js","mtime":1555844217316}],"contextDependencies":[],"result":["\"use strict\";\n/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar tslib_1 = require(\"tslib\");\nvar async_1 = require(\"vs/base/common/async\");\nvar cancellation_1 = require(\"vs/base/common/cancellation\");\nvar errors = require(\"vs/base/common/errors\");\nvar event_1 = require(\"vs/base/common/event\");\nvar labels_1 = require(\"vs/base/common/labels\");\nvar lifecycle_1 = require(\"vs/base/common/lifecycle\");\nvar map_1 = require(\"vs/base/common/map\");\nvar objects = require(\"vs/base/common/objects\");\nvar strings_1 = require(\"vs/base/common/strings\");\nvar uri_1 = require(\"vs/base/common/uri\");\nvar range_1 = require(\"vs/editor/common/core/range\");\nvar model_1 = require(\"vs/editor/common/model\");\nvar textModel_1 = require(\"vs/editor/common/model/textModel\");\nvar modelService_1 = require(\"vs/editor/common/services/modelService\");\nvar instantiation_1 = require(\"vs/platform/instantiation/common/instantiation\");\nvar replace_1 = require(\"vs/workbench/services/search/common/replace\");\nvar search_1 = require(\"vs/workbench/services/search/common/search\");\nvar telemetry_1 = require(\"vs/platform/telemetry/common/telemetry\");\nvar colorRegistry_1 = require(\"vs/platform/theme/common/colorRegistry\");\nvar themeService_1 = require(\"vs/platform/theme/common/themeService\");\nvar replace_2 = require(\"vs/workbench/contrib/search/common/replace\");\nvar searchHelpers_1 = require(\"vs/workbench/services/search/common/searchHelpers\");\nvar types_1 = require(\"vs/base/common/types\");\nvar Match = /** @class */ (function () {\n    function Match(_parent, _fullPreviewLines, _fullPreviewRange, _documentRange) {\n        this._parent = _parent;\n        this._fullPreviewLines = _fullPreviewLines;\n        this._oneLinePreviewText = _fullPreviewLines[_fullPreviewRange.startLineNumber];\n        var adjustedEndCol = _fullPreviewRange.startLineNumber === _fullPreviewRange.endLineNumber ?\n            _fullPreviewRange.endColumn :\n            this._oneLinePreviewText.length;\n        this._rangeInPreviewText = new search_1.OneLineRange(1, _fullPreviewRange.startColumn + 1, adjustedEndCol + 1);\n        this._range = new range_1.Range(_documentRange.startLineNumber + 1, _documentRange.startColumn + 1, _documentRange.endLineNumber + 1, _documentRange.endColumn + 1);\n        this._fullPreviewRange = _fullPreviewRange;\n        this._id = this._parent.id() + '>' + this._range + this.getMatchString();\n    }\n    Match.prototype.id = function () {\n        return this._id;\n    };\n    Match.prototype.parent = function () {\n        return this._parent;\n    };\n    Match.prototype.text = function () {\n        return this._oneLinePreviewText;\n    };\n    Match.prototype.range = function () {\n        return this._range;\n    };\n    Match.prototype.preview = function () {\n        var before = this._oneLinePreviewText.substring(0, this._rangeInPreviewText.startColumn - 1), inside = this.getMatchString(), after = this._oneLinePreviewText.substring(this._rangeInPreviewText.endColumn - 1);\n        before = strings_1.lcut(before, 26);\n        before = before.trimLeft();\n        var charsRemaining = Match.MAX_PREVIEW_CHARS - before.length;\n        inside = inside.substr(0, charsRemaining);\n        charsRemaining -= inside.length;\n        after = after.substr(0, charsRemaining);\n        return {\n            before: before,\n            inside: inside,\n            after: after,\n        };\n    };\n    Object.defineProperty(Match.prototype, \"replaceString\", {\n        get: function () {\n            var searchModel = this.parent().parent().searchModel;\n            if (!searchModel.replacePattern) {\n                throw new Error('searchModel.replacePattern must be set before accessing replaceString');\n            }\n            var fullMatchText = this.fullMatchText();\n            var replaceString = searchModel.replacePattern.getReplaceString(fullMatchText);\n            // If match string is not matching then regex pattern has a lookahead expression\n            if (replaceString === null) {\n                var fullMatchTextWithTrailingContent = this.fullMatchText(true);\n                replaceString = searchModel.replacePattern.getReplaceString(fullMatchTextWithTrailingContent);\n                // Search/find normalize line endings - check whether \\r prevents regex from matching\n                if (replaceString === null) {\n                    var fullMatchTextWithoutCR = fullMatchTextWithTrailingContent.replace(/\\r\\n/g, '\\n');\n                    replaceString = searchModel.replacePattern.getReplaceString(fullMatchTextWithoutCR);\n                }\n            }\n            // Match string is still not matching. Could be unsupported matches (multi-line).\n            if (replaceString === null) {\n                replaceString = searchModel.replacePattern.pattern;\n            }\n            return replaceString;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Match.prototype.fullMatchText = function (includeTrailing) {\n        if (includeTrailing === void 0) { includeTrailing = false; }\n        var thisMatchPreviewLines;\n        if (includeTrailing) {\n            thisMatchPreviewLines = this._fullPreviewLines.slice(this._fullPreviewRange.startLineNumber);\n        }\n        else {\n            thisMatchPreviewLines = this._fullPreviewLines.slice(this._fullPreviewRange.startLineNumber, this._fullPreviewRange.endLineNumber + 1);\n            thisMatchPreviewLines[thisMatchPreviewLines.length - 1] = thisMatchPreviewLines[thisMatchPreviewLines.length - 1].slice(0, this._fullPreviewRange.endColumn);\n        }\n        thisMatchPreviewLines[0] = thisMatchPreviewLines[0].slice(this._fullPreviewRange.startColumn);\n        return thisMatchPreviewLines.join('\\n');\n    };\n    Match.prototype.fullPreviewLines = function () {\n        return this._fullPreviewLines.slice(this._fullPreviewRange.startLineNumber, this._fullPreviewRange.endLineNumber + 1);\n    };\n    Match.prototype.getMatchString = function () {\n        return this._oneLinePreviewText.substring(this._rangeInPreviewText.startColumn - 1, this._rangeInPreviewText.endColumn - 1);\n    };\n    Match.MAX_PREVIEW_CHARS = 250;\n    return Match;\n}());\nexports.Match = Match;\nvar FileMatch = /** @class */ (function (_super) {\n    tslib_1.__extends(FileMatch, _super);\n    function FileMatch(_query, _previewOptions, _maxResults, _parent, rawMatch, modelService, replaceService) {\n        var _this = _super.call(this) || this;\n        _this._query = _query;\n        _this._previewOptions = _previewOptions;\n        _this._maxResults = _maxResults;\n        _this._parent = _parent;\n        _this.rawMatch = rawMatch;\n        _this.modelService = modelService;\n        _this.replaceService = replaceService;\n        _this._onChange = _this._register(new event_1.Emitter());\n        _this.onChange = _this._onChange.event;\n        _this._onDispose = _this._register(new event_1.Emitter());\n        _this.onDispose = _this._onDispose.event;\n        _this._modelDecorations = [];\n        _this._resource = _this.rawMatch.resource;\n        _this._matches = new Map();\n        _this._removedMatches = new Set();\n        _this._updateScheduler = new async_1.RunOnceScheduler(_this.updateMatchesForModel.bind(_this), 250);\n        _this.createMatches();\n        return _this;\n    }\n    FileMatch.getDecorationOption = function (selected) {\n        return (selected ? FileMatch._CURRENT_FIND_MATCH : FileMatch._FIND_MATCH);\n    };\n    FileMatch.prototype.createMatches = function () {\n        var _this = this;\n        var model = this.modelService.getModel(this._resource);\n        if (model) {\n            this.bindModel(model);\n            this.updateMatchesForModel();\n        }\n        else {\n            this.rawMatch.results\n                .filter(search_1.resultIsMatch)\n                .forEach(function (rawMatch) {\n                textSearchResultToMatches(rawMatch, _this)\n                    .forEach(function (m) { return _this.add(m); });\n            });\n        }\n    };\n    FileMatch.prototype.bindModel = function (model) {\n        var _this = this;\n        this._model = model;\n        this._modelListener = this._model.onDidChangeContent(function () {\n            _this._updateScheduler.schedule();\n        });\n        this._model.onWillDispose(function () { return _this.onModelWillDispose(); });\n        this.updateHighlights();\n    };\n    FileMatch.prototype.onModelWillDispose = function () {\n        // Update matches because model might have some dirty changes\n        this.updateMatchesForModel();\n        this.unbindModel();\n    };\n    FileMatch.prototype.unbindModel = function () {\n        if (this._model) {\n            this._updateScheduler.cancel();\n            this._model.deltaDecorations(this._modelDecorations, []);\n            this._model = null;\n            this._modelListener.dispose();\n        }\n    };\n    FileMatch.prototype.updateMatchesForModel = function () {\n        // this is called from a timeout and might fire\n        // after the model has been disposed\n        if (!this._model) {\n            return;\n        }\n        this._matches = new Map();\n        var wordSeparators = this._query.isWordMatch && this._query.wordSeparators ? this._query.wordSeparators : null;\n        var matches = this._model\n            .findMatches(this._query.pattern, this._model.getFullModelRange(), !!this._query.isRegExp, !!this._query.isCaseSensitive, wordSeparators, false, this._maxResults);\n        this.updateMatches(matches, true);\n    };\n    FileMatch.prototype.updatesMatchesForLineAfterReplace = function (lineNumber, modelChange) {\n        var _this = this;\n        if (!this._model) {\n            return;\n        }\n        var range = {\n            startLineNumber: lineNumber,\n            startColumn: this._model.getLineMinColumn(lineNumber),\n            endLineNumber: lineNumber,\n            endColumn: this._model.getLineMaxColumn(lineNumber)\n        };\n        var oldMatches = map_1.values(this._matches).filter(function (match) { return match.range().startLineNumber === lineNumber; });\n        oldMatches.forEach(function (match) { return _this._matches.delete(match.id()); });\n        var wordSeparators = this._query.isWordMatch && this._query.wordSeparators ? this._query.wordSeparators : null;\n        var matches = this._model.findMatches(this._query.pattern, range, !!this._query.isRegExp, !!this._query.isCaseSensitive, wordSeparators, false, this._maxResults);\n        this.updateMatches(matches, modelChange);\n    };\n    FileMatch.prototype.updateMatches = function (matches, modelChange) {\n        var _this = this;\n        if (!this._model) {\n            return;\n        }\n        var textSearchResults = searchHelpers_1.editorMatchesToTextSearchResults(matches, this._model, this._previewOptions);\n        textSearchResults.forEach(function (textSearchResult) {\n            textSearchResultToMatches(textSearchResult, _this).forEach(function (match) {\n                if (!_this._removedMatches.has(match.id())) {\n                    _this.add(match);\n                    if (_this.isMatchSelected(match)) {\n                        _this._selectedMatch = match;\n                    }\n                }\n            });\n        });\n        this._onChange.fire(modelChange);\n        this.updateHighlights();\n    };\n    FileMatch.prototype.updateHighlights = function () {\n        var _this = this;\n        if (!this._model) {\n            return;\n        }\n        if (this.parent().showHighlights) {\n            this._modelDecorations = this._model.deltaDecorations(this._modelDecorations, this.matches().map(function (match) { return ({\n                range: match.range(),\n                options: FileMatch.getDecorationOption(_this.isMatchSelected(match))\n            }); }));\n        }\n        else {\n            this._modelDecorations = this._model.deltaDecorations(this._modelDecorations, []);\n        }\n    };\n    FileMatch.prototype.id = function () {\n        return this.resource().toString();\n    };\n    FileMatch.prototype.parent = function () {\n        return this._parent;\n    };\n    FileMatch.prototype.matches = function () {\n        return map_1.values(this._matches);\n    };\n    FileMatch.prototype.remove = function (match) {\n        this.removeMatch(match);\n        this._removedMatches.add(match.id());\n        this._onChange.fire(false);\n    };\n    FileMatch.prototype.replace = function (toReplace) {\n        var _this = this;\n        return this.replaceService.replace(toReplace)\n            .then(function () { return _this.updatesMatchesForLineAfterReplace(toReplace.range().startLineNumber, false); });\n    };\n    FileMatch.prototype.setSelectedMatch = function (match) {\n        if (match) {\n            if (!this._matches.has(match.id())) {\n                return;\n            }\n            if (this.isMatchSelected(match)) {\n                return;\n            }\n        }\n        this._selectedMatch = match;\n        this.updateHighlights();\n    };\n    FileMatch.prototype.getSelectedMatch = function () {\n        return this._selectedMatch;\n    };\n    FileMatch.prototype.isMatchSelected = function (match) {\n        return !!this._selectedMatch && this._selectedMatch.id() === match.id();\n    };\n    FileMatch.prototype.count = function () {\n        return this.matches().length;\n    };\n    FileMatch.prototype.resource = function () {\n        return this._resource;\n    };\n    FileMatch.prototype.name = function () {\n        return labels_1.getBaseLabel(this.resource());\n    };\n    FileMatch.prototype.add = function (match, trigger) {\n        this._matches.set(match.id(), match);\n        if (trigger) {\n            this._onChange.fire(true);\n        }\n    };\n    FileMatch.prototype.removeMatch = function (match) {\n        this._matches.delete(match.id());\n        if (this.isMatchSelected(match)) {\n            this.setSelectedMatch(null);\n        }\n        else {\n            this.updateHighlights();\n        }\n    };\n    FileMatch.prototype.dispose = function () {\n        this.setSelectedMatch(null);\n        this.unbindModel();\n        this._onDispose.fire();\n        _super.prototype.dispose.call(this);\n    };\n    FileMatch._CURRENT_FIND_MATCH = textModel_1.ModelDecorationOptions.register({\n        stickiness: model_1.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,\n        zIndex: 13,\n        className: 'currentFindMatch',\n        overviewRuler: {\n            color: themeService_1.themeColorFromId(colorRegistry_1.overviewRulerFindMatchForeground),\n            position: model_1.OverviewRulerLane.Center\n        }\n    });\n    FileMatch._FIND_MATCH = textModel_1.ModelDecorationOptions.register({\n        stickiness: model_1.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,\n        className: 'findMatch',\n        overviewRuler: {\n            color: themeService_1.themeColorFromId(colorRegistry_1.overviewRulerFindMatchForeground),\n            position: model_1.OverviewRulerLane.Center\n        }\n    });\n    FileMatch = tslib_1.__decorate([\n        tslib_1.__param(5, modelService_1.IModelService), tslib_1.__param(6, replace_2.IReplaceService)\n    ], FileMatch);\n    return FileMatch;\n}(lifecycle_1.Disposable));\nexports.FileMatch = FileMatch;\nvar BaseFolderMatch = /** @class */ (function (_super) {\n    tslib_1.__extends(BaseFolderMatch, _super);\n    function BaseFolderMatch(_resource, _id, _index, _query, _parent, _searchModel, replaceService, instantiationService) {\n        var _this = _super.call(this) || this;\n        _this._resource = _resource;\n        _this._id = _id;\n        _this._index = _index;\n        _this._query = _query;\n        _this._parent = _parent;\n        _this._searchModel = _searchModel;\n        _this.replaceService = replaceService;\n        _this.instantiationService = instantiationService;\n        _this._onChange = _this._register(new event_1.Emitter());\n        _this.onChange = _this._onChange.event;\n        _this._onDispose = _this._register(new event_1.Emitter());\n        _this.onDispose = _this._onDispose.event;\n        _this._replacingAll = false;\n        _this._fileMatches = new map_1.ResourceMap();\n        _this._unDisposedFileMatches = new map_1.ResourceMap();\n        return _this;\n    }\n    Object.defineProperty(BaseFolderMatch.prototype, \"searchModel\", {\n        get: function () {\n            return this._searchModel;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(BaseFolderMatch.prototype, \"showHighlights\", {\n        get: function () {\n            return this._parent.showHighlights;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(BaseFolderMatch.prototype, \"replacingAll\", {\n        set: function (b) {\n            this._replacingAll = b;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    BaseFolderMatch.prototype.id = function () {\n        return this._id;\n    };\n    BaseFolderMatch.prototype.resource = function () {\n        return this._resource;\n    };\n    BaseFolderMatch.prototype.index = function () {\n        return this._index;\n    };\n    BaseFolderMatch.prototype.name = function () {\n        return labels_1.getBaseLabel(types_1.withNullAsUndefined(this.resource())) || '';\n    };\n    BaseFolderMatch.prototype.parent = function () {\n        return this._parent;\n    };\n    BaseFolderMatch.prototype.hasResource = function () {\n        return !!this._resource;\n    };\n    BaseFolderMatch.prototype.bindModel = function (model) {\n        var fileMatch = this._fileMatches.get(model.uri);\n        if (fileMatch) {\n            fileMatch.bindModel(model);\n        }\n    };\n    BaseFolderMatch.prototype.add = function (raw, silent) {\n        var _this = this;\n        var added = [];\n        var updated = [];\n        raw.forEach(function (rawFileMatch) {\n            var existingFileMatch = _this._fileMatches.get(rawFileMatch.resource);\n            if (existingFileMatch) {\n                rawFileMatch\n                    .results\n                    .filter(search_1.resultIsMatch)\n                    .forEach(function (m) {\n                    textSearchResultToMatches(m, existingFileMatch)\n                        .forEach(function (m) { return existingFileMatch.add(m); });\n                });\n                updated.push(existingFileMatch);\n            }\n            else {\n                var fileMatch_1 = _this.instantiationService.createInstance(FileMatch, _this._query.contentPattern, _this._query.previewOptions, _this._query.maxResults, _this, rawFileMatch);\n                _this.doAdd(fileMatch_1);\n                added.push(fileMatch_1);\n                var disposable_1 = fileMatch_1.onChange(function () { return _this.onFileChange(fileMatch_1); });\n                fileMatch_1.onDispose(function () { return disposable_1.dispose(); });\n            }\n        });\n        var elements = added.concat(updated);\n        if (!silent && elements.length) {\n            this._onChange.fire({ elements: elements, added: !!added.length });\n        }\n    };\n    BaseFolderMatch.prototype.clear = function () {\n        var changed = this.matches();\n        this.disposeMatches();\n        this._onChange.fire({ elements: changed, removed: true });\n    };\n    BaseFolderMatch.prototype.remove = function (match) {\n        this.doRemove(match);\n    };\n    BaseFolderMatch.prototype.replace = function (match) {\n        var _this = this;\n        return this.replaceService.replace([match]).then(function () {\n            _this.doRemove(match, false, true);\n        });\n    };\n    BaseFolderMatch.prototype.replaceAll = function () {\n        var _this = this;\n        var matches = this.matches();\n        return this.replaceService.replace(matches).then(function () {\n            matches.forEach(function (match) { return _this.doRemove(match, false, true); });\n        });\n    };\n    BaseFolderMatch.prototype.matches = function () {\n        return this._fileMatches.values();\n    };\n    BaseFolderMatch.prototype.isEmpty = function () {\n        return this.fileCount() === 0;\n    };\n    BaseFolderMatch.prototype.fileCount = function () {\n        return this._fileMatches.size;\n    };\n    BaseFolderMatch.prototype.count = function () {\n        return this.matches().reduce(function (prev, match) { return prev + match.count(); }, 0);\n    };\n    BaseFolderMatch.prototype.onFileChange = function (fileMatch) {\n        var added = false;\n        var removed = false;\n        if (!this._fileMatches.has(fileMatch.resource())) {\n            this.doAdd(fileMatch);\n            added = true;\n        }\n        if (fileMatch.count() === 0) {\n            this.doRemove(fileMatch, false, false);\n            added = false;\n            removed = true;\n        }\n        if (!this._replacingAll) {\n            this._onChange.fire({ elements: [fileMatch], added: added, removed: removed });\n        }\n    };\n    BaseFolderMatch.prototype.doAdd = function (fileMatch) {\n        this._fileMatches.set(fileMatch.resource(), fileMatch);\n        if (this._unDisposedFileMatches.has(fileMatch.resource())) {\n            this._unDisposedFileMatches.delete(fileMatch.resource());\n        }\n    };\n    BaseFolderMatch.prototype.doRemove = function (fileMatch, dispose, trigger) {\n        if (dispose === void 0) { dispose = true; }\n        if (trigger === void 0) { trigger = true; }\n        this._fileMatches.delete(fileMatch.resource());\n        if (dispose) {\n            fileMatch.dispose();\n        }\n        else {\n            this._unDisposedFileMatches.set(fileMatch.resource(), fileMatch);\n        }\n        if (trigger) {\n            this._onChange.fire({ elements: [fileMatch], removed: true });\n        }\n    };\n    BaseFolderMatch.prototype.disposeMatches = function () {\n        this._fileMatches.values().forEach(function (fileMatch) { return fileMatch.dispose(); });\n        this._unDisposedFileMatches.values().forEach(function (fileMatch) { return fileMatch.dispose(); });\n        this._fileMatches.clear();\n        this._unDisposedFileMatches.clear();\n    };\n    BaseFolderMatch.prototype.dispose = function () {\n        this.disposeMatches();\n        this._onDispose.fire();\n        _super.prototype.dispose.call(this);\n    };\n    BaseFolderMatch = tslib_1.__decorate([\n        tslib_1.__param(6, replace_2.IReplaceService),\n        tslib_1.__param(7, instantiation_1.IInstantiationService)\n    ], BaseFolderMatch);\n    return BaseFolderMatch;\n}(lifecycle_1.Disposable));\nexports.BaseFolderMatch = BaseFolderMatch;\n/**\n * BaseFolderMatch => optional resource (\"other files\" node)\n * FolderMatch => required resource (normal folder node)\n */\nvar FolderMatch = /** @class */ (function (_super) {\n    tslib_1.__extends(FolderMatch, _super);\n    function FolderMatch(_resource, _id, _index, _query, _parent, _searchModel, replaceService, instantiationService) {\n        return _super.call(this, _resource, _id, _index, _query, _parent, _searchModel, replaceService, instantiationService) || this;\n    }\n    FolderMatch.prototype.resource = function () {\n        return this._resource;\n    };\n    FolderMatch = tslib_1.__decorate([\n        tslib_1.__param(6, replace_2.IReplaceService),\n        tslib_1.__param(7, instantiation_1.IInstantiationService)\n    ], FolderMatch);\n    return FolderMatch;\n}(BaseFolderMatch));\nexports.FolderMatch = FolderMatch;\n/**\n * Compares instances of the same match type. Different match types should not be siblings\n * and their sort order is undefined.\n */\nfunction searchMatchComparer(elementA, elementB) {\n    if (elementA instanceof BaseFolderMatch && elementB instanceof BaseFolderMatch) {\n        return elementA.index() - elementB.index();\n    }\n    if (elementA instanceof FileMatch && elementB instanceof FileMatch) {\n        return elementA.resource().fsPath.localeCompare(elementB.resource().fsPath) || elementA.name().localeCompare(elementB.name());\n    }\n    if (elementA instanceof Match && elementB instanceof Match) {\n        return range_1.Range.compareRangesUsingStarts(elementA.range(), elementB.range());\n    }\n    return 0;\n}\nexports.searchMatchComparer = searchMatchComparer;\nvar SearchResult = /** @class */ (function (_super) {\n    tslib_1.__extends(SearchResult, _super);\n    function SearchResult(_searchModel, replaceService, telemetryService, instantiationService, modelService) {\n        var _this = _super.call(this) || this;\n        _this._searchModel = _searchModel;\n        _this.replaceService = replaceService;\n        _this.telemetryService = telemetryService;\n        _this.instantiationService = instantiationService;\n        _this.modelService = modelService;\n        _this._onChange = _this._register(new event_1.Emitter());\n        _this.onChange = _this._onChange.event;\n        _this._folderMatches = [];\n        _this._folderMatchesMap = map_1.TernarySearchTree.forPaths();\n        _this._rangeHighlightDecorations = _this.instantiationService.createInstance(RangeHighlightDecorations);\n        _this._register(_this.modelService.onModelAdded(function (model) { return _this.onModelAdded(model); }));\n        return _this;\n    }\n    Object.defineProperty(SearchResult.prototype, \"query\", {\n        get: function () {\n            return this._query;\n        },\n        set: function (query) {\n            var _this = this;\n            // When updating the query we could change the roots, so ensure we clean up the old roots first.\n            this.clear();\n            this._folderMatches = (query.folderQueries || [])\n                .map(function (fq) { return fq.folder; })\n                .map(function (resource, index) { return _this.createFolderMatch(resource, resource.toString(), index, query); });\n            this._folderMatches.forEach(function (fm) { return _this._folderMatchesMap.set(fm.resource().toString(), fm); });\n            this._otherFilesMatch = this.createOtherFilesFolderMatch('otherFiles', this._folderMatches.length + 1, query);\n            this._query = query;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    SearchResult.prototype.onModelAdded = function (model) {\n        var folderMatch = this._folderMatchesMap.findSubstr(model.uri.toString());\n        if (folderMatch) {\n            folderMatch.bindModel(model);\n        }\n    };\n    SearchResult.prototype.createFolderMatch = function (resource, id, index, query) {\n        return this._createBaseFolderMatch(FolderMatch, resource, id, index, query);\n    };\n    SearchResult.prototype.createOtherFilesFolderMatch = function (id, index, query) {\n        return this._createBaseFolderMatch(BaseFolderMatch, null, id, index, query);\n    };\n    SearchResult.prototype._createBaseFolderMatch = function (folderMatchClass, resource, id, index, query) {\n        var _this = this;\n        var folderMatch = this.instantiationService.createInstance(folderMatchClass, resource, id, index, query, this, this._searchModel);\n        var disposable = folderMatch.onChange(function (event) { return _this._onChange.fire(event); });\n        folderMatch.onDispose(function () { return disposable.dispose(); });\n        return folderMatch;\n    };\n    Object.defineProperty(SearchResult.prototype, \"searchModel\", {\n        get: function () {\n            return this._searchModel;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    SearchResult.prototype.add = function (allRaw, silent) {\n        var _this = this;\n        if (silent === void 0) { silent = false; }\n        // Split up raw into a list per folder so we can do a batch add per folder.\n        var rawPerFolder = new map_1.ResourceMap();\n        var otherFileMatches = [];\n        this._folderMatches.forEach(function (fm) { return rawPerFolder.set(fm.resource(), []); });\n        allRaw.forEach(function (rawFileMatch) {\n            var folderMatch = _this.getFolderMatch(rawFileMatch.resource);\n            if (!folderMatch) {\n                // foldermatch was previously removed by user or disposed for some reason\n                return;\n            }\n            var resource = folderMatch.resource();\n            if (resource) {\n                rawPerFolder.get(resource).push(rawFileMatch);\n            }\n            else {\n                otherFileMatches.push(rawFileMatch);\n            }\n        });\n        rawPerFolder.forEach(function (raw) {\n            if (!raw.length) {\n                return;\n            }\n            var folderMatch = _this.getFolderMatch(raw[0].resource);\n            if (folderMatch) {\n                folderMatch.add(raw, silent);\n            }\n        });\n        this._otherFilesMatch.add(otherFileMatches, silent);\n    };\n    SearchResult.prototype.clear = function () {\n        this.folderMatches().forEach(function (folderMatch) { return folderMatch.clear(); });\n        this.disposeMatches();\n    };\n    SearchResult.prototype.remove = function (match) {\n        if (match instanceof FileMatch) {\n            this.getFolderMatch(match.resource()).remove(match);\n        }\n        else {\n            match.clear();\n        }\n    };\n    SearchResult.prototype.replace = function (match) {\n        return this.getFolderMatch(match.resource()).replace(match);\n    };\n    SearchResult.prototype.replaceAll = function (progressRunner) {\n        var _this = this;\n        this.replacingAll = true;\n        var promise = this.replaceService.replace(this.matches(), progressRunner);\n        var onDone = event_1.Event.stopwatch(event_1.Event.fromPromise(promise));\n        /* __GDPR__\n            \"replaceAll.started\" : {\n                \"duration\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\", \"isMeasurement\": true }\n            }\n        */\n        onDone(function (duration) { return _this.telemetryService.publicLog('replaceAll.started', { duration: duration }); });\n        return promise.then(function () {\n            _this.replacingAll = false;\n            _this.clear();\n        }, function () {\n            _this.replacingAll = false;\n        });\n    };\n    SearchResult.prototype.folderMatches = function () {\n        return this._otherFilesMatch ? this._folderMatches.concat([\n            this._otherFilesMatch\n        ]) : this._folderMatches.slice();\n    };\n    SearchResult.prototype.matches = function () {\n        var _a;\n        var matches = [];\n        this.folderMatches().forEach(function (folderMatch) {\n            matches.push(folderMatch.matches());\n        });\n        return (_a = []).concat.apply(_a, matches);\n    };\n    SearchResult.prototype.isEmpty = function () {\n        return this.folderMatches().every(function (folderMatch) { return folderMatch.isEmpty(); });\n    };\n    SearchResult.prototype.fileCount = function () {\n        return this.folderMatches().reduce(function (prev, match) { return prev + match.fileCount(); }, 0);\n    };\n    SearchResult.prototype.count = function () {\n        return this.matches().reduce(function (prev, match) { return prev + match.count(); }, 0);\n    };\n    Object.defineProperty(SearchResult.prototype, \"showHighlights\", {\n        get: function () {\n            return this._showHighlights;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    SearchResult.prototype.toggleHighlights = function (value) {\n        if (this._showHighlights === value) {\n            return;\n        }\n        this._showHighlights = value;\n        var selectedMatch = null;\n        this.matches().forEach(function (fileMatch) {\n            fileMatch.updateHighlights();\n            if (!selectedMatch) {\n                selectedMatch = fileMatch.getSelectedMatch();\n            }\n        });\n        if (this._showHighlights && selectedMatch) {\n            // TS?\n            this._rangeHighlightDecorations.highlightRange(selectedMatch.parent().resource(), selectedMatch.range());\n        }\n        else {\n            this._rangeHighlightDecorations.removeHighlightRange();\n        }\n    };\n    Object.defineProperty(SearchResult.prototype, \"rangeHighlightDecorations\", {\n        get: function () {\n            return this._rangeHighlightDecorations;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    SearchResult.prototype.getFolderMatch = function (resource) {\n        var folderMatch = this._folderMatchesMap.findSubstr(resource.toString());\n        return folderMatch ? folderMatch : this._otherFilesMatch;\n    };\n    Object.defineProperty(SearchResult.prototype, \"replacingAll\", {\n        set: function (running) {\n            this.folderMatches().forEach(function (folderMatch) {\n                folderMatch.replacingAll = running;\n            });\n        },\n        enumerable: true,\n        configurable: true\n    });\n    SearchResult.prototype.disposeMatches = function () {\n        this.folderMatches().forEach(function (folderMatch) { return folderMatch.dispose(); });\n        this._folderMatches = [];\n        this._folderMatchesMap = map_1.TernarySearchTree.forPaths();\n        this._rangeHighlightDecorations.removeHighlightRange();\n    };\n    SearchResult.prototype.dispose = function () {\n        this.disposeMatches();\n        this._rangeHighlightDecorations.dispose();\n        _super.prototype.dispose.call(this);\n    };\n    SearchResult = tslib_1.__decorate([\n        tslib_1.__param(1, replace_2.IReplaceService),\n        tslib_1.__param(2, telemetry_1.ITelemetryService),\n        tslib_1.__param(3, instantiation_1.IInstantiationService),\n        tslib_1.__param(4, modelService_1.IModelService)\n    ], SearchResult);\n    return SearchResult;\n}(lifecycle_1.Disposable));\nexports.SearchResult = SearchResult;\nvar SearchModel = /** @class */ (function (_super) {\n    tslib_1.__extends(SearchModel, _super);\n    function SearchModel(searchService, telemetryService, instantiationService) {\n        var _this = _super.call(this) || this;\n        _this.searchService = searchService;\n        _this.telemetryService = telemetryService;\n        _this.instantiationService = instantiationService;\n        _this._searchQuery = null;\n        _this._replaceActive = false;\n        _this._replaceString = null;\n        _this._replacePattern = null;\n        _this._onReplaceTermChanged = _this._register(new event_1.Emitter());\n        _this.onReplaceTermChanged = _this._onReplaceTermChanged.event;\n        _this._searchResult = _this.instantiationService.createInstance(SearchResult, _this);\n        return _this;\n    }\n    SearchModel.prototype.isReplaceActive = function () {\n        return this._replaceActive;\n    };\n    Object.defineProperty(SearchModel.prototype, \"replaceActive\", {\n        set: function (replaceActive) {\n            this._replaceActive = replaceActive;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(SearchModel.prototype, \"replacePattern\", {\n        get: function () {\n            return this._replacePattern;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(SearchModel.prototype, \"replaceString\", {\n        get: function () {\n            return this._replaceString || '';\n        },\n        set: function (replaceString) {\n            this._replaceString = replaceString;\n            if (this._searchQuery) {\n                this._replacePattern = new replace_1.ReplacePattern(replaceString, this._searchQuery.contentPattern);\n            }\n            this._onReplaceTermChanged.fire();\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(SearchModel.prototype, \"searchResult\", {\n        get: function () {\n            return this._searchResult;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    SearchModel.prototype.search = function (query, onProgress) {\n        var _this = this;\n        this.cancelSearch();\n        this._searchQuery = query;\n        this.searchResult.clear();\n        this._searchResult.query = this._searchQuery;\n        var progressEmitter = new event_1.Emitter();\n        this._replacePattern = new replace_1.ReplacePattern(this.replaceString, this._searchQuery.contentPattern);\n        var tokenSource = this.currentCancelTokenSource = new cancellation_1.CancellationTokenSource();\n        var currentRequest = this.searchService.textSearch(this._searchQuery, this.currentCancelTokenSource.token, function (p) {\n            progressEmitter.fire();\n            _this.onSearchProgress(p);\n            if (onProgress) {\n                onProgress(p);\n            }\n        });\n        var dispose = function () { return tokenSource.dispose(); };\n        currentRequest.then(dispose, dispose);\n        var onDone = event_1.Event.fromPromise(currentRequest);\n        var onFirstRender = event_1.Event.any(onDone, progressEmitter.event);\n        var onFirstRenderStopwatch = event_1.Event.stopwatch(onFirstRender);\n        /* __GDPR__\n            \"searchResultsFirstRender\" : {\n                \"duration\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\", \"isMeasurement\": true }\n            }\n        */\n        onFirstRenderStopwatch(function (duration) { return _this.telemetryService.publicLog('searchResultsFirstRender', { duration: duration }); });\n        var onDoneStopwatch = event_1.Event.stopwatch(onDone);\n        var start = Date.now();\n        /* __GDPR__\n            \"searchResultsFinished\" : {\n                \"duration\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\", \"isMeasurement\": true }\n            }\n        */\n        onDoneStopwatch(function (duration) { return _this.telemetryService.publicLog('searchResultsFinished', { duration: duration }); });\n        currentRequest.then(function (value) { return _this.onSearchCompleted(value, Date.now() - start); }, function (e) { return _this.onSearchError(e, Date.now() - start); });\n        return currentRequest;\n    };\n    SearchModel.prototype.onSearchCompleted = function (completed, duration) {\n        if (!this._searchQuery) {\n            throw new Error('onSearchCompleted must be called after a search is started');\n        }\n        var options = objects.assign({}, this._searchQuery.contentPattern);\n        delete options.pattern;\n        var stats = completed && completed.stats;\n        var fileSchemeOnly = this._searchQuery.folderQueries.every(function (fq) { return fq.folder.scheme === 'file'; });\n        var otherSchemeOnly = this._searchQuery.folderQueries.every(function (fq) { return fq.folder.scheme !== 'file'; });\n        var scheme = fileSchemeOnly ? 'file' :\n            otherSchemeOnly ? 'other' :\n                'mixed';\n        /* __GDPR__\n            \"searchResultsShown\" : {\n                \"count\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\", \"isMeasurement\": true },\n                \"fileCount\": { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\", \"isMeasurement\": true },\n                \"options\": { \"${inline}\": [ \"${IPatternInfo}\" ] },\n                \"duration\": { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\", \"isMeasurement\": true },\n                \"type\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\" },\n                \"scheme\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\" }\n            }\n        */\n        this.telemetryService.publicLog('searchResultsShown', {\n            count: this._searchResult.count(),\n            fileCount: this._searchResult.fileCount(),\n            options: options,\n            duration: duration,\n            type: stats && stats.type,\n            scheme: scheme\n        });\n        return completed;\n    };\n    SearchModel.prototype.onSearchError = function (e, duration) {\n        if (errors.isPromiseCanceledError(e)) {\n            this.onSearchCompleted(null, duration);\n        }\n    };\n    SearchModel.prototype.onSearchProgress = function (p) {\n        if (p.resource) {\n            this._searchResult.add([p], true);\n        }\n    };\n    SearchModel.prototype.cancelSearch = function () {\n        if (this.currentCancelTokenSource) {\n            this.currentCancelTokenSource.cancel();\n            return true;\n        }\n        return false;\n    };\n    SearchModel.prototype.dispose = function () {\n        this.cancelSearch();\n        this.searchResult.dispose();\n        _super.prototype.dispose.call(this);\n    };\n    SearchModel = tslib_1.__decorate([\n        tslib_1.__param(0, search_1.ISearchService),\n        tslib_1.__param(1, telemetry_1.ITelemetryService),\n        tslib_1.__param(2, instantiation_1.IInstantiationService)\n    ], SearchModel);\n    return SearchModel;\n}(lifecycle_1.Disposable));\nexports.SearchModel = SearchModel;\nvar SearchWorkbenchService = /** @class */ (function () {\n    function SearchWorkbenchService(instantiationService) {\n        this.instantiationService = instantiationService;\n    }\n    Object.defineProperty(SearchWorkbenchService.prototype, \"searchModel\", {\n        get: function () {\n            if (!this._searchModel) {\n                this._searchModel = this.instantiationService.createInstance(SearchModel);\n            }\n            return this._searchModel;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    SearchWorkbenchService = tslib_1.__decorate([\n        tslib_1.__param(0, instantiation_1.IInstantiationService)\n    ], SearchWorkbenchService);\n    return SearchWorkbenchService;\n}());\nexports.SearchWorkbenchService = SearchWorkbenchService;\nexports.ISearchWorkbenchService = instantiation_1.createDecorator('searchWorkbenchService');\n/**\n * Can add a range highlight decoration to a model.\n * It will automatically remove it when the model has its decorations changed.\n */\nvar RangeHighlightDecorations = /** @class */ (function () {\n    function RangeHighlightDecorations(_modelService) {\n        this._modelService = _modelService;\n        this._decorationId = null;\n        this._model = null;\n        this._modelDisposables = [];\n    }\n    RangeHighlightDecorations.prototype.removeHighlightRange = function () {\n        if (this._model && this._decorationId) {\n            this._model.deltaDecorations([this._decorationId], []);\n        }\n        this._decorationId = null;\n    };\n    RangeHighlightDecorations.prototype.highlightRange = function (resource, range, ownerId) {\n        if (ownerId === void 0) { ownerId = 0; }\n        var model;\n        if (uri_1.URI.isUri(resource)) {\n            model = this._modelService.getModel(resource);\n        }\n        else {\n            model = resource;\n        }\n        if (model) {\n            this.doHighlightRange(model, range);\n        }\n    };\n    RangeHighlightDecorations.prototype.doHighlightRange = function (model, range) {\n        this.removeHighlightRange();\n        this._decorationId = model.deltaDecorations([], [{ range: range, options: RangeHighlightDecorations._RANGE_HIGHLIGHT_DECORATION }])[0];\n        this.setModel(model);\n    };\n    RangeHighlightDecorations.prototype.setModel = function (model) {\n        var _this = this;\n        if (this._model !== model) {\n            this.disposeModelListeners();\n            this._model = model;\n            this._modelDisposables.push(this._model.onDidChangeDecorations(function (e) {\n                _this.disposeModelListeners();\n                _this.removeHighlightRange();\n                _this._model = null;\n            }));\n            this._modelDisposables.push(this._model.onWillDispose(function () {\n                _this.disposeModelListeners();\n                _this.removeHighlightRange();\n                _this._model = null;\n            }));\n        }\n    };\n    RangeHighlightDecorations.prototype.disposeModelListeners = function () {\n        this._modelDisposables.forEach(function (disposable) { return disposable.dispose(); });\n        this._modelDisposables = [];\n    };\n    RangeHighlightDecorations.prototype.dispose = function () {\n        if (this._model) {\n            this.removeHighlightRange();\n            this.disposeModelListeners();\n            this._model = null;\n        }\n    };\n    RangeHighlightDecorations._RANGE_HIGHLIGHT_DECORATION = textModel_1.ModelDecorationOptions.register({\n        stickiness: model_1.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,\n        className: 'rangeHighlight',\n        isWholeLine: true\n    });\n    RangeHighlightDecorations = tslib_1.__decorate([\n        tslib_1.__param(0, modelService_1.IModelService)\n    ], RangeHighlightDecorations);\n    return RangeHighlightDecorations;\n}());\nexports.RangeHighlightDecorations = RangeHighlightDecorations;\nfunction textSearchResultToMatches(rawMatch, fileMatch) {\n    var previewLines = rawMatch.preview.text.split('\\n');\n    if (Array.isArray(rawMatch.ranges)) {\n        return rawMatch.ranges.map(function (r, i) {\n            var previewRange = rawMatch.preview.matches[i];\n            return new Match(fileMatch, previewLines, previewRange, r);\n        });\n    }\n    else {\n        var previewRange = rawMatch.preview.matches;\n        var match = new Match(fileMatch, previewLines, previewRange, rawMatch.ranges);\n        return [match];\n    }\n}\n",{"version":3,"file":"/home/coding/workspace/lib/vscode/src/vs/workbench/contrib/search/common/searchModel.ts","sourceRoot":"","sources":["/home/coding/workspace/lib/vscode/src/vs/workbench/contrib/search/common/searchModel.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { RunOnceScheduler } from 'vs/base/common/async';\nimport { CancellationTokenSource } from 'vs/base/common/cancellation';\nimport * as errors from 'vs/base/common/errors';\nimport { Emitter, Event } from 'vs/base/common/event';\nimport { getBaseLabel } from 'vs/base/common/labels';\nimport { Disposable, IDisposable } from 'vs/base/common/lifecycle';\nimport { ResourceMap, TernarySearchTree, values } from 'vs/base/common/map';\nimport * as objects from 'vs/base/common/objects';\nimport { lcut } from 'vs/base/common/strings';\nimport { URI } from 'vs/base/common/uri';\nimport { Range } from 'vs/editor/common/core/range';\nimport { FindMatch, IModelDeltaDecoration, ITextModel, OverviewRulerLane, TrackedRangeStickiness } from 'vs/editor/common/model';\nimport { ModelDecorationOptions } from 'vs/editor/common/model/textModel';\nimport { IModelService } from 'vs/editor/common/services/modelService';\nimport { createDecorator, IInstantiationService } from 'vs/platform/instantiation/common/instantiation';\nimport { IProgressRunner } from 'vs/platform/progress/common/progress';\nimport { ReplacePattern } from 'vs/workbench/services/search/common/replace';\nimport { IFileMatch, IPatternInfo, ISearchComplete, ISearchProgressItem, ISearchService, ITextQuery, ITextSearchPreviewOptions, ITextSearchMatch, ITextSearchStats, resultIsMatch, ISearchRange, OneLineRange } from 'vs/workbench/services/search/common/search';\nimport { ITelemetryService } from 'vs/platform/telemetry/common/telemetry';\nimport { overviewRulerFindMatchForeground } from 'vs/platform/theme/common/colorRegistry';\nimport { themeColorFromId } from 'vs/platform/theme/common/themeService';\nimport { IReplaceService } from 'vs/workbench/contrib/search/common/replace';\nimport { editorMatchesToTextSearchResults } from 'vs/workbench/services/search/common/searchHelpers';\nimport { withNullAsUndefined } from 'vs/base/common/types';\n\nexport class Match {\n\n\tprivate static readonly MAX_PREVIEW_CHARS = 250;\n\n\tprivate _id: string;\n\tprivate _range: Range;\n\tprivate _oneLinePreviewText: string;\n\tprivate _rangeInPreviewText: ISearchRange;\n\n\t// For replace\n\tprivate _fullPreviewRange: ISearchRange;\n\n\tconstructor(private _parent: FileMatch, private _fullPreviewLines: string[], _fullPreviewRange: ISearchRange, _documentRange: ISearchRange) {\n\t\tthis._oneLinePreviewText = _fullPreviewLines[_fullPreviewRange.startLineNumber];\n\t\tconst adjustedEndCol = _fullPreviewRange.startLineNumber === _fullPreviewRange.endLineNumber ?\n\t\t\t_fullPreviewRange.endColumn :\n\t\t\tthis._oneLinePreviewText.length;\n\t\tthis._rangeInPreviewText = new OneLineRange(1, _fullPreviewRange.startColumn + 1, adjustedEndCol + 1);\n\n\t\tthis._range = new Range(\n\t\t\t_documentRange.startLineNumber + 1,\n\t\t\t_documentRange.startColumn + 1,\n\t\t\t_documentRange.endLineNumber + 1,\n\t\t\t_documentRange.endColumn + 1);\n\n\t\tthis._fullPreviewRange = _fullPreviewRange;\n\n\t\tthis._id = this._parent.id() + '>' + this._range + this.getMatchString();\n\t}\n\n\tid(): string {\n\t\treturn this._id;\n\t}\n\n\tparent(): FileMatch {\n\t\treturn this._parent;\n\t}\n\n\ttext(): string {\n\t\treturn this._oneLinePreviewText;\n\t}\n\n\trange(): Range {\n\t\treturn this._range;\n\t}\n\n\tpreview(): { before: string; inside: string; after: string; } {\n\t\tlet before = this._oneLinePreviewText.substring(0, this._rangeInPreviewText.startColumn - 1),\n\t\t\tinside = this.getMatchString(),\n\t\t\tafter = this._oneLinePreviewText.substring(this._rangeInPreviewText.endColumn - 1);\n\n\t\tbefore = lcut(before, 26);\n\t\tbefore = before.trimLeft();\n\n\t\tlet charsRemaining = Match.MAX_PREVIEW_CHARS - before.length;\n\t\tinside = inside.substr(0, charsRemaining);\n\t\tcharsRemaining -= inside.length;\n\t\tafter = after.substr(0, charsRemaining);\n\n\t\treturn {\n\t\t\tbefore,\n\t\t\tinside,\n\t\t\tafter,\n\t\t};\n\t}\n\n\tget replaceString(): string {\n\t\tconst searchModel = this.parent().parent().searchModel;\n\t\tif (!searchModel.replacePattern) {\n\t\t\tthrow new Error('searchModel.replacePattern must be set before accessing replaceString');\n\t\t}\n\n\t\tconst fullMatchText = this.fullMatchText();\n\t\tlet replaceString = searchModel.replacePattern.getReplaceString(fullMatchText);\n\n\t\t// If match string is not matching then regex pattern has a lookahead expression\n\t\tif (replaceString === null) {\n\t\t\tconst fullMatchTextWithTrailingContent = this.fullMatchText(true);\n\t\t\treplaceString = searchModel.replacePattern.getReplaceString(fullMatchTextWithTrailingContent);\n\n\t\t\t// Search/find normalize line endings - check whether \\r prevents regex from matching\n\t\t\tif (replaceString === null) {\n\t\t\t\tconst fullMatchTextWithoutCR = fullMatchTextWithTrailingContent.replace(/\\r\\n/g, '\\n');\n\t\t\t\treplaceString = searchModel.replacePattern.getReplaceString(fullMatchTextWithoutCR);\n\t\t\t}\n\t\t}\n\n\t\t// Match string is still not matching. Could be unsupported matches (multi-line).\n\t\tif (replaceString === null) {\n\t\t\treplaceString = searchModel.replacePattern.pattern;\n\t\t}\n\n\t\treturn replaceString;\n\t}\n\n\tfullMatchText(includeTrailing = false): string {\n\t\tlet thisMatchPreviewLines: string[];\n\t\tif (includeTrailing) {\n\t\t\tthisMatchPreviewLines = this._fullPreviewLines.slice(this._fullPreviewRange.startLineNumber);\n\t\t} else {\n\t\t\tthisMatchPreviewLines = this._fullPreviewLines.slice(this._fullPreviewRange.startLineNumber, this._fullPreviewRange.endLineNumber + 1);\n\t\t\tthisMatchPreviewLines[thisMatchPreviewLines.length - 1] = thisMatchPreviewLines[thisMatchPreviewLines.length - 1].slice(0, this._fullPreviewRange.endColumn);\n\n\t\t}\n\n\t\tthisMatchPreviewLines[0] = thisMatchPreviewLines[0].slice(this._fullPreviewRange.startColumn);\n\t\treturn thisMatchPreviewLines.join('\\n');\n\t}\n\n\tfullPreviewLines(): string[] {\n\t\treturn this._fullPreviewLines.slice(this._fullPreviewRange.startLineNumber, this._fullPreviewRange.endLineNumber + 1);\n\t}\n\n\tgetMatchString(): string {\n\t\treturn this._oneLinePreviewText.substring(this._rangeInPreviewText.startColumn - 1, this._rangeInPreviewText.endColumn - 1);\n\t}\n}\n\nexport class FileMatch extends Disposable {\n\n\tprivate static readonly _CURRENT_FIND_MATCH = ModelDecorationOptions.register({\n\t\tstickiness: TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,\n\t\tzIndex: 13,\n\t\tclassName: 'currentFindMatch',\n\t\toverviewRuler: {\n\t\t\tcolor: themeColorFromId(overviewRulerFindMatchForeground),\n\t\t\tposition: OverviewRulerLane.Center\n\t\t}\n\t});\n\n\tprivate static readonly _FIND_MATCH = ModelDecorationOptions.register({\n\t\tstickiness: TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,\n\t\tclassName: 'findMatch',\n\t\toverviewRuler: {\n\t\t\tcolor: themeColorFromId(overviewRulerFindMatchForeground),\n\t\t\tposition: OverviewRulerLane.Center\n\t\t}\n\t});\n\n\tprivate static getDecorationOption(selected: boolean): ModelDecorationOptions {\n\t\treturn (selected ? FileMatch._CURRENT_FIND_MATCH : FileMatch._FIND_MATCH);\n\t}\n\n\tprivate _onChange = this._register(new Emitter<boolean>());\n\treadonly onChange: Event<boolean> = this._onChange.event;\n\n\tprivate _onDispose = this._register(new Emitter<void>());\n\treadonly onDispose: Event<void> = this._onDispose.event;\n\n\tprivate _resource: URI;\n\tprivate _model: ITextModel | null;\n\tprivate _modelListener: IDisposable;\n\tprivate _matches: Map<string, Match>;\n\tprivate _removedMatches: Set<string>;\n\tprivate _selectedMatch: Match | null;\n\n\tprivate _updateScheduler: RunOnceScheduler;\n\tprivate _modelDecorations: string[] = [];\n\n\tconstructor(private _query: IPatternInfo, private _previewOptions: ITextSearchPreviewOptions, private _maxResults: number, private _parent: BaseFolderMatch, private rawMatch: IFileMatch,\n\t\t@IModelService private readonly modelService: IModelService, @IReplaceService private readonly replaceService: IReplaceService\n\t) {\n\t\tsuper();\n\t\tthis._resource = this.rawMatch.resource;\n\t\tthis._matches = new Map<string, Match>();\n\t\tthis._removedMatches = new Set<string>();\n\t\tthis._updateScheduler = new RunOnceScheduler(this.updateMatchesForModel.bind(this), 250);\n\n\t\tthis.createMatches();\n\t}\n\n\tprivate createMatches(): void {\n\t\tconst model = this.modelService.getModel(this._resource);\n\t\tif (model) {\n\t\t\tthis.bindModel(model);\n\t\t\tthis.updateMatchesForModel();\n\t\t} else {\n\t\t\tthis.rawMatch.results!\n\t\t\t\t.filter(resultIsMatch)\n\t\t\t\t.forEach(rawMatch => {\n\t\t\t\t\ttextSearchResultToMatches(rawMatch, this)\n\t\t\t\t\t\t.forEach(m => this.add(m));\n\t\t\t\t});\n\t\t}\n\t}\n\n\tbindModel(model: ITextModel): void {\n\t\tthis._model = model;\n\t\tthis._modelListener = this._model.onDidChangeContent(() => {\n\t\t\tthis._updateScheduler.schedule();\n\t\t});\n\t\tthis._model.onWillDispose(() => this.onModelWillDispose());\n\t\tthis.updateHighlights();\n\t}\n\n\tprivate onModelWillDispose(): void {\n\t\t// Update matches because model might have some dirty changes\n\t\tthis.updateMatchesForModel();\n\t\tthis.unbindModel();\n\t}\n\n\tprivate unbindModel(): void {\n\t\tif (this._model) {\n\t\t\tthis._updateScheduler.cancel();\n\t\t\tthis._model.deltaDecorations(this._modelDecorations, []);\n\t\t\tthis._model = null;\n\t\t\tthis._modelListener.dispose();\n\t\t}\n\t}\n\n\tprivate updateMatchesForModel(): void {\n\t\t// this is called from a timeout and might fire\n\t\t// after the model has been disposed\n\t\tif (!this._model) {\n\t\t\treturn;\n\t\t}\n\t\tthis._matches = new Map<string, Match>();\n\n\t\tconst wordSeparators = this._query.isWordMatch && this._query.wordSeparators ? this._query.wordSeparators : null;\n\t\tconst matches = this._model\n\t\t\t.findMatches(this._query.pattern, this._model.getFullModelRange(), !!this._query.isRegExp, !!this._query.isCaseSensitive, wordSeparators, false, this._maxResults);\n\n\t\tthis.updateMatches(matches, true);\n\t}\n\n\tprivate updatesMatchesForLineAfterReplace(lineNumber: number, modelChange: boolean): void {\n\t\tif (!this._model) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst range = {\n\t\t\tstartLineNumber: lineNumber,\n\t\t\tstartColumn: this._model.getLineMinColumn(lineNumber),\n\t\t\tendLineNumber: lineNumber,\n\t\t\tendColumn: this._model.getLineMaxColumn(lineNumber)\n\t\t};\n\t\tconst oldMatches = values(this._matches).filter(match => match.range().startLineNumber === lineNumber);\n\t\toldMatches.forEach(match => this._matches.delete(match.id()));\n\n\t\tconst wordSeparators = this._query.isWordMatch && this._query.wordSeparators ? this._query.wordSeparators : null;\n\t\tconst matches = this._model.findMatches(this._query.pattern, range, !!this._query.isRegExp, !!this._query.isCaseSensitive, wordSeparators, false, this._maxResults);\n\t\tthis.updateMatches(matches, modelChange);\n\t}\n\n\tprivate updateMatches(matches: FindMatch[], modelChange: boolean): void {\n\t\tif (!this._model) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst textSearchResults = editorMatchesToTextSearchResults(matches, this._model, this._previewOptions);\n\t\ttextSearchResults.forEach(textSearchResult => {\n\t\t\ttextSearchResultToMatches(textSearchResult, this).forEach(match => {\n\t\t\t\tif (!this._removedMatches.has(match.id())) {\n\t\t\t\t\tthis.add(match);\n\t\t\t\t\tif (this.isMatchSelected(match)) {\n\t\t\t\t\t\tthis._selectedMatch = match;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tthis._onChange.fire(modelChange);\n\t\tthis.updateHighlights();\n\t}\n\n\tupdateHighlights(): void {\n\t\tif (!this._model) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.parent().showHighlights) {\n\t\t\tthis._modelDecorations = this._model.deltaDecorations(this._modelDecorations, this.matches().map(match => <IModelDeltaDecoration>{\n\t\t\t\trange: match.range(),\n\t\t\t\toptions: FileMatch.getDecorationOption(this.isMatchSelected(match))\n\t\t\t}));\n\t\t} else {\n\t\t\tthis._modelDecorations = this._model.deltaDecorations(this._modelDecorations, []);\n\t\t}\n\t}\n\n\tid(): string {\n\t\treturn this.resource().toString();\n\t}\n\n\tparent(): BaseFolderMatch {\n\t\treturn this._parent;\n\t}\n\n\tmatches(): Match[] {\n\t\treturn values(this._matches);\n\t}\n\n\tremove(match: Match): void {\n\t\tthis.removeMatch(match);\n\t\tthis._removedMatches.add(match.id());\n\t\tthis._onChange.fire(false);\n\t}\n\n\treplace(toReplace: Match): Promise<void> {\n\t\treturn this.replaceService.replace(toReplace)\n\t\t\t.then(() => this.updatesMatchesForLineAfterReplace(toReplace.range().startLineNumber, false));\n\t}\n\n\tsetSelectedMatch(match: Match | null): void {\n\t\tif (match) {\n\t\t\tif (!this._matches.has(match.id())) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (this.isMatchSelected(match)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis._selectedMatch = match;\n\t\tthis.updateHighlights();\n\t}\n\n\tgetSelectedMatch(): Match | null {\n\t\treturn this._selectedMatch;\n\t}\n\n\tisMatchSelected(match: Match): boolean {\n\t\treturn !!this._selectedMatch && this._selectedMatch.id() === match.id();\n\t}\n\n\tcount(): number {\n\t\treturn this.matches().length;\n\t}\n\n\tresource(): URI {\n\t\treturn this._resource;\n\t}\n\n\tname(): string {\n\t\treturn getBaseLabel(this.resource());\n\t}\n\n\tadd(match: Match, trigger?: boolean) {\n\t\tthis._matches.set(match.id(), match);\n\t\tif (trigger) {\n\t\t\tthis._onChange.fire(true);\n\t\t}\n\t}\n\n\tprivate removeMatch(match: Match) {\n\t\tthis._matches.delete(match.id());\n\t\tif (this.isMatchSelected(match)) {\n\t\t\tthis.setSelectedMatch(null);\n\t\t} else {\n\t\t\tthis.updateHighlights();\n\t\t}\n\t}\n\n\tdispose(): void {\n\t\tthis.setSelectedMatch(null);\n\t\tthis.unbindModel();\n\t\tthis._onDispose.fire();\n\t\tsuper.dispose();\n\t}\n}\n\nexport interface IChangeEvent {\n\telements: (FileMatch | FolderMatch | SearchResult)[];\n\tadded?: boolean;\n\tremoved?: boolean;\n}\n\nexport class BaseFolderMatch extends Disposable {\n\n\tprivate _onChange = this._register(new Emitter<IChangeEvent>());\n\treadonly onChange: Event<IChangeEvent> = this._onChange.event;\n\n\tprivate _onDispose = this._register(new Emitter<void>());\n\treadonly onDispose: Event<void> = this._onDispose.event;\n\n\tprivate _fileMatches: ResourceMap<FileMatch>;\n\tprivate _unDisposedFileMatches: ResourceMap<FileMatch>;\n\tprivate _replacingAll: boolean = false;\n\n\tconstructor(protected _resource: URI | null, private _id: string, private _index: number, private _query: ITextQuery, private _parent: SearchResult, private _searchModel: SearchModel,\n\t\t@IReplaceService private readonly replaceService: IReplaceService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService\n\t) {\n\t\tsuper();\n\t\tthis._fileMatches = new ResourceMap<FileMatch>();\n\t\tthis._unDisposedFileMatches = new ResourceMap<FileMatch>();\n\t}\n\n\tget searchModel(): SearchModel {\n\t\treturn this._searchModel;\n\t}\n\n\tget showHighlights(): boolean {\n\t\treturn this._parent.showHighlights;\n\t}\n\n\tset replacingAll(b: boolean) {\n\t\tthis._replacingAll = b;\n\t}\n\n\tid(): string {\n\t\treturn this._id;\n\t}\n\n\tresource(): URI | null {\n\t\treturn this._resource;\n\t}\n\n\tindex(): number {\n\t\treturn this._index;\n\t}\n\n\tname(): string {\n\t\treturn getBaseLabel(withNullAsUndefined(this.resource())) || '';\n\t}\n\n\tparent(): SearchResult {\n\t\treturn this._parent;\n\t}\n\n\thasResource(): boolean {\n\t\treturn !!this._resource;\n\t}\n\n\tbindModel(model: ITextModel): void {\n\t\tconst fileMatch = this._fileMatches.get(model.uri);\n\t\tif (fileMatch) {\n\t\t\tfileMatch.bindModel(model);\n\t\t}\n\t}\n\n\tadd(raw: IFileMatch[], silent: boolean): void {\n\t\tconst added: FileMatch[] = [];\n\t\tconst updated: FileMatch[] = [];\n\t\traw.forEach(rawFileMatch => {\n\t\t\tconst existingFileMatch = this._fileMatches.get(rawFileMatch.resource);\n\t\t\tif (existingFileMatch) {\n\t\t\t\trawFileMatch\n\t\t\t\t\t.results!\n\t\t\t\t\t.filter(resultIsMatch)\n\t\t\t\t\t.forEach(m => {\n\t\t\t\t\t\ttextSearchResultToMatches(m, existingFileMatch)\n\t\t\t\t\t\t\t.forEach(m => existingFileMatch.add(m));\n\t\t\t\t\t});\n\t\t\t\tupdated.push(existingFileMatch);\n\t\t\t} else {\n\t\t\t\tconst fileMatch = this.instantiationService.createInstance(FileMatch, this._query.contentPattern, this._query.previewOptions, this._query.maxResults, this, rawFileMatch);\n\t\t\t\tthis.doAdd(fileMatch);\n\t\t\t\tadded.push(fileMatch);\n\t\t\t\tconst disposable = fileMatch.onChange(() => this.onFileChange(fileMatch));\n\t\t\t\tfileMatch.onDispose(() => disposable.dispose());\n\t\t\t}\n\t\t});\n\n\t\tconst elements = [...added, ...updated];\n\t\tif (!silent && elements.length) {\n\t\t\tthis._onChange.fire({ elements, added: !!added.length });\n\t\t}\n\t}\n\n\tclear(): void {\n\t\tconst changed: FileMatch[] = this.matches();\n\t\tthis.disposeMatches();\n\t\tthis._onChange.fire({ elements: changed, removed: true });\n\t}\n\n\tremove(match: FileMatch): void {\n\t\tthis.doRemove(match);\n\t}\n\n\treplace(match: FileMatch): Promise<any> {\n\t\treturn this.replaceService.replace([match]).then(() => {\n\t\t\tthis.doRemove(match, false, true);\n\t\t});\n\t}\n\n\treplaceAll(): Promise<any> {\n\t\tconst matches = this.matches();\n\t\treturn this.replaceService.replace(matches).then(() => {\n\t\t\tmatches.forEach(match => this.doRemove(match, false, true));\n\t\t});\n\t}\n\n\tmatches(): FileMatch[] {\n\t\treturn this._fileMatches.values();\n\t}\n\n\tisEmpty(): boolean {\n\t\treturn this.fileCount() === 0;\n\t}\n\n\tfileCount(): number {\n\t\treturn this._fileMatches.size;\n\t}\n\n\tcount(): number {\n\t\treturn this.matches().reduce<number>((prev, match) => prev + match.count(), 0);\n\t}\n\n\tprivate onFileChange(fileMatch: FileMatch): void {\n\t\tlet added: boolean = false;\n\t\tlet removed: boolean = false;\n\t\tif (!this._fileMatches.has(fileMatch.resource())) {\n\t\t\tthis.doAdd(fileMatch);\n\t\t\tadded = true;\n\t\t}\n\t\tif (fileMatch.count() === 0) {\n\t\t\tthis.doRemove(fileMatch, false, false);\n\t\t\tadded = false;\n\t\t\tremoved = true;\n\t\t}\n\t\tif (!this._replacingAll) {\n\t\t\tthis._onChange.fire({ elements: [fileMatch], added: added, removed: removed });\n\t\t}\n\t}\n\n\tprivate doAdd(fileMatch: FileMatch): void {\n\t\tthis._fileMatches.set(fileMatch.resource(), fileMatch);\n\t\tif (this._unDisposedFileMatches.has(fileMatch.resource())) {\n\t\t\tthis._unDisposedFileMatches.delete(fileMatch.resource());\n\t\t}\n\t}\n\n\tprivate doRemove(fileMatch: FileMatch, dispose: boolean = true, trigger: boolean = true): void {\n\t\tthis._fileMatches.delete(fileMatch.resource());\n\t\tif (dispose) {\n\t\t\tfileMatch.dispose();\n\t\t} else {\n\t\t\tthis._unDisposedFileMatches.set(fileMatch.resource(), fileMatch);\n\t\t}\n\n\t\tif (trigger) {\n\t\t\tthis._onChange.fire({ elements: [fileMatch], removed: true });\n\t\t}\n\t}\n\n\tprivate disposeMatches(): void {\n\t\tthis._fileMatches.values().forEach((fileMatch: FileMatch) => fileMatch.dispose());\n\t\tthis._unDisposedFileMatches.values().forEach((fileMatch: FileMatch) => fileMatch.dispose());\n\t\tthis._fileMatches.clear();\n\t\tthis._unDisposedFileMatches.clear();\n\t}\n\n\tdispose(): void {\n\t\tthis.disposeMatches();\n\t\tthis._onDispose.fire();\n\t\tsuper.dispose();\n\t}\n}\n\n/**\n * BaseFolderMatch => optional resource (\"other files\" node)\n * FolderMatch => required resource (normal folder node)\n */\nexport class FolderMatch extends BaseFolderMatch {\n\tconstructor(_resource: URI, _id: string, _index: number, _query: ITextQuery, _parent: SearchResult, _searchModel: SearchModel,\n\t\t@IReplaceService replaceService: IReplaceService,\n\t\t@IInstantiationService instantiationService: IInstantiationService\n\t) {\n\t\tsuper(_resource, _id, _index, _query, _parent, _searchModel, replaceService, instantiationService);\n\t}\n\n\tresource(): URI {\n\t\treturn this._resource!;\n\t}\n}\n\n/**\n * Compares instances of the same match type. Different match types should not be siblings\n * and their sort order is undefined.\n */\nexport function searchMatchComparer(elementA: RenderableMatch, elementB: RenderableMatch): number {\n\tif (elementA instanceof BaseFolderMatch && elementB instanceof BaseFolderMatch) {\n\t\treturn elementA.index() - elementB.index();\n\t}\n\n\tif (elementA instanceof FileMatch && elementB instanceof FileMatch) {\n\t\treturn elementA.resource().fsPath.localeCompare(elementB.resource().fsPath) || elementA.name().localeCompare(elementB.name());\n\t}\n\n\tif (elementA instanceof Match && elementB instanceof Match) {\n\t\treturn Range.compareRangesUsingStarts(elementA.range(), elementB.range());\n\t}\n\n\treturn 0;\n}\n\nexport class SearchResult extends Disposable {\n\n\tprivate _onChange = this._register(new Emitter<IChangeEvent>());\n\treadonly onChange: Event<IChangeEvent> = this._onChange.event;\n\n\tprivate _folderMatches: FolderMatch[] = [];\n\tprivate _otherFilesMatch: BaseFolderMatch;\n\tprivate _folderMatchesMap: TernarySearchTree<FolderMatch> = TernarySearchTree.forPaths<FolderMatch>();\n\tprivate _showHighlights: boolean;\n\tprivate _query: ITextQuery;\n\n\tprivate _rangeHighlightDecorations: RangeHighlightDecorations;\n\n\tconstructor(\n\t\tprivate _searchModel: SearchModel,\n\t\t@IReplaceService private readonly replaceService: IReplaceService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@IModelService private readonly modelService: IModelService,\n\t) {\n\t\tsuper();\n\t\tthis._rangeHighlightDecorations = this.instantiationService.createInstance(RangeHighlightDecorations);\n\n\t\tthis._register(this.modelService.onModelAdded(model => this.onModelAdded(model)));\n\t}\n\n\tget query(): ITextQuery {\n\t\treturn this._query;\n\t}\n\n\tset query(query: ITextQuery) {\n\t\t// When updating the query we could change the roots, so ensure we clean up the old roots first.\n\t\tthis.clear();\n\t\tthis._folderMatches = (query.folderQueries || [])\n\t\t\t.map(fq => fq.folder)\n\t\t\t.map((resource, index) => this.createFolderMatch(resource, resource.toString(), index, query));\n\n\t\tthis._folderMatches.forEach(fm => this._folderMatchesMap.set(fm.resource().toString(), fm));\n\t\tthis._otherFilesMatch = this.createOtherFilesFolderMatch('otherFiles', this._folderMatches.length + 1, query);\n\n\t\tthis._query = query;\n\t}\n\n\tprivate onModelAdded(model: ITextModel): void {\n\t\tconst folderMatch = this._folderMatchesMap.findSubstr(model.uri.toString());\n\t\tif (folderMatch) {\n\t\t\tfolderMatch.bindModel(model);\n\t\t}\n\t}\n\n\tprivate createFolderMatch(resource: URI, id: string, index: number, query: ITextQuery): FolderMatch {\n\t\treturn <FolderMatch>this._createBaseFolderMatch(FolderMatch, resource, id, index, query);\n\t}\n\n\tprivate createOtherFilesFolderMatch(id: string, index: number, query: ITextQuery): BaseFolderMatch {\n\t\treturn this._createBaseFolderMatch(BaseFolderMatch, null, id, index, query);\n\t}\n\n\tprivate _createBaseFolderMatch(folderMatchClass: typeof BaseFolderMatch | typeof FolderMatch, resource: URI | null, id: string, index: number, query: ITextQuery): BaseFolderMatch {\n\t\tconst folderMatch = this.instantiationService.createInstance(folderMatchClass, resource, id, index, query, this, this._searchModel);\n\t\tconst disposable = folderMatch.onChange((event) => this._onChange.fire(event));\n\t\tfolderMatch.onDispose(() => disposable.dispose());\n\t\treturn folderMatch;\n\t}\n\n\tget searchModel(): SearchModel {\n\t\treturn this._searchModel;\n\t}\n\n\tadd(allRaw: IFileMatch[], silent: boolean = false): void {\n\t\t// Split up raw into a list per folder so we can do a batch add per folder.\n\t\tconst rawPerFolder = new ResourceMap<IFileMatch[]>();\n\t\tconst otherFileMatches: IFileMatch[] = [];\n\t\tthis._folderMatches.forEach(fm => rawPerFolder.set(fm.resource(), []));\n\n\t\tallRaw.forEach(rawFileMatch => {\n\t\t\tconst folderMatch = this.getFolderMatch(rawFileMatch.resource);\n\t\t\tif (!folderMatch) {\n\t\t\t\t// foldermatch was previously removed by user or disposed for some reason\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst resource = folderMatch.resource();\n\t\t\tif (resource) {\n\t\t\t\trawPerFolder.get(resource)!.push(rawFileMatch);\n\t\t\t} else {\n\t\t\t\totherFileMatches.push(rawFileMatch);\n\t\t\t}\n\t\t});\n\n\t\trawPerFolder.forEach((raw) => {\n\t\t\tif (!raw.length) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst folderMatch = this.getFolderMatch(raw[0].resource);\n\t\t\tif (folderMatch) {\n\t\t\t\tfolderMatch.add(raw, silent);\n\t\t\t}\n\t\t});\n\n\t\tthis._otherFilesMatch!.add(otherFileMatches, silent);\n\t}\n\n\tclear(): void {\n\t\tthis.folderMatches().forEach((folderMatch) => folderMatch.clear());\n\t\tthis.disposeMatches();\n\t}\n\n\tremove(match: FileMatch | FolderMatch): void {\n\t\tif (match instanceof FileMatch) {\n\t\t\tthis.getFolderMatch(match.resource()).remove(match);\n\t\t} else {\n\t\t\tmatch.clear();\n\t\t}\n\t}\n\n\treplace(match: FileMatch): Promise<any> {\n\t\treturn this.getFolderMatch(match.resource()).replace(match);\n\t}\n\n\treplaceAll(progressRunner: IProgressRunner): Promise<any> {\n\t\tthis.replacingAll = true;\n\n\t\tconst promise = this.replaceService.replace(this.matches(), progressRunner);\n\t\tconst onDone = Event.stopwatch(Event.fromPromise(promise));\n\t\t/* __GDPR__\n\t\t\t\"replaceAll.started\" : {\n\t\t\t\t\"duration\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\", \"isMeasurement\": true }\n\t\t\t}\n\t\t*/\n\t\tonDone(duration => this.telemetryService.publicLog('replaceAll.started', { duration }));\n\n\t\treturn promise.then(() => {\n\t\t\tthis.replacingAll = false;\n\t\t\tthis.clear();\n\t\t}, () => {\n\t\t\tthis.replacingAll = false;\n\t\t});\n\t}\n\n\tfolderMatches(): BaseFolderMatch[] {\n\t\treturn this._otherFilesMatch ?\n\t\t\t[\n\t\t\t\t...this._folderMatches,\n\t\t\t\tthis._otherFilesMatch\n\t\t\t] :\n\t\t\t[\n\t\t\t\t...this._folderMatches\n\t\t\t];\n\t}\n\n\tmatches(): FileMatch[] {\n\t\tconst matches: FileMatch[][] = [];\n\t\tthis.folderMatches().forEach(folderMatch => {\n\t\t\tmatches.push(folderMatch.matches());\n\t\t});\n\n\t\treturn (<FileMatch[]>[]).concat(...matches);\n\t}\n\n\tisEmpty(): boolean {\n\t\treturn this.folderMatches().every((folderMatch) => folderMatch.isEmpty());\n\t}\n\n\tfileCount(): number {\n\t\treturn this.folderMatches().reduce<number>((prev, match) => prev + match.fileCount(), 0);\n\t}\n\n\tcount(): number {\n\t\treturn this.matches().reduce<number>((prev, match) => prev + match.count(), 0);\n\t}\n\n\tget showHighlights(): boolean {\n\t\treturn this._showHighlights;\n\t}\n\n\ttoggleHighlights(value: boolean): void {\n\t\tif (this._showHighlights === value) {\n\t\t\treturn;\n\t\t}\n\t\tthis._showHighlights = value;\n\t\tlet selectedMatch: Match | null = null;\n\t\tthis.matches().forEach((fileMatch: FileMatch) => {\n\t\t\tfileMatch.updateHighlights();\n\t\t\tif (!selectedMatch) {\n\t\t\t\tselectedMatch = fileMatch.getSelectedMatch();\n\t\t\t}\n\t\t});\n\t\tif (this._showHighlights && selectedMatch) {\n\t\t\t// TS?\n\t\t\tthis._rangeHighlightDecorations.highlightRange(\n\t\t\t\t(<Match>selectedMatch).parent().resource(),\n\t\t\t\t(<Match>selectedMatch).range()\n\t\t\t);\n\t\t} else {\n\t\t\tthis._rangeHighlightDecorations.removeHighlightRange();\n\t\t}\n\t}\n\n\tget rangeHighlightDecorations(): RangeHighlightDecorations {\n\t\treturn this._rangeHighlightDecorations;\n\t}\n\n\tprivate getFolderMatch(resource: URI): BaseFolderMatch {\n\t\tconst folderMatch = this._folderMatchesMap.findSubstr(resource.toString());\n\t\treturn folderMatch ? folderMatch : this._otherFilesMatch;\n\t}\n\n\tprivate set replacingAll(running: boolean) {\n\t\tthis.folderMatches().forEach((folderMatch) => {\n\t\t\tfolderMatch.replacingAll = running;\n\t\t});\n\t}\n\n\tprivate disposeMatches(): void {\n\t\tthis.folderMatches().forEach(folderMatch => folderMatch.dispose());\n\t\tthis._folderMatches = [];\n\t\tthis._folderMatchesMap = TernarySearchTree.forPaths<FolderMatch>();\n\t\tthis._rangeHighlightDecorations.removeHighlightRange();\n\t}\n\n\tdispose(): void {\n\t\tthis.disposeMatches();\n\t\tthis._rangeHighlightDecorations.dispose();\n\t\tsuper.dispose();\n\t}\n}\n\nexport class SearchModel extends Disposable {\n\n\tprivate _searchResult: SearchResult;\n\tprivate _searchQuery: ITextQuery | null = null;\n\tprivate _replaceActive: boolean = false;\n\tprivate _replaceString: string | null = null;\n\tprivate _replacePattern: ReplacePattern | null = null;\n\n\tprivate readonly _onReplaceTermChanged: Emitter<void> = this._register(new Emitter<void>());\n\treadonly onReplaceTermChanged: Event<void> = this._onReplaceTermChanged.event;\n\n\tprivate currentCancelTokenSource: CancellationTokenSource;\n\n\tconstructor(\n\t\t@ISearchService private readonly searchService: ISearchService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService\n\t) {\n\t\tsuper();\n\t\tthis._searchResult = this.instantiationService.createInstance(SearchResult, this);\n\t}\n\n\tisReplaceActive(): boolean {\n\t\treturn this._replaceActive;\n\t}\n\n\tset replaceActive(replaceActive: boolean) {\n\t\tthis._replaceActive = replaceActive;\n\t}\n\n\tget replacePattern(): ReplacePattern | null {\n\t\treturn this._replacePattern;\n\t}\n\n\tget replaceString(): string {\n\t\treturn this._replaceString || '';\n\t}\n\n\tset replaceString(replaceString: string) {\n\t\tthis._replaceString = replaceString;\n\t\tif (this._searchQuery) {\n\t\t\tthis._replacePattern = new ReplacePattern(replaceString, this._searchQuery.contentPattern);\n\t\t}\n\t\tthis._onReplaceTermChanged.fire();\n\t}\n\n\tget searchResult(): SearchResult {\n\t\treturn this._searchResult;\n\t}\n\n\tsearch(query: ITextQuery, onProgress?: (result: ISearchProgressItem) => void): Promise<ISearchComplete> {\n\t\tthis.cancelSearch();\n\n\t\tthis._searchQuery = query;\n\t\tthis.searchResult.clear();\n\t\tthis._searchResult.query = this._searchQuery;\n\n\t\tconst progressEmitter = new Emitter<void>();\n\t\tthis._replacePattern = new ReplacePattern(this.replaceString, this._searchQuery.contentPattern);\n\n\t\tconst tokenSource = this.currentCancelTokenSource = new CancellationTokenSource();\n\t\tconst currentRequest = this.searchService.textSearch(this._searchQuery, this.currentCancelTokenSource.token, p => {\n\t\t\tprogressEmitter.fire();\n\t\t\tthis.onSearchProgress(p);\n\n\t\t\tif (onProgress) {\n\t\t\t\tonProgress(p);\n\t\t\t}\n\t\t});\n\n\t\tconst dispose = () => tokenSource.dispose();\n\t\tcurrentRequest.then(dispose, dispose);\n\n\t\tconst onDone = Event.fromPromise(currentRequest);\n\t\tconst onFirstRender = Event.any<any>(onDone, progressEmitter.event);\n\t\tconst onFirstRenderStopwatch = Event.stopwatch(onFirstRender);\n\t\t/* __GDPR__\n\t\t\t\"searchResultsFirstRender\" : {\n\t\t\t\t\"duration\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\", \"isMeasurement\": true }\n\t\t\t}\n\t\t*/\n\t\tonFirstRenderStopwatch(duration => this.telemetryService.publicLog('searchResultsFirstRender', { duration }));\n\n\t\tconst onDoneStopwatch = Event.stopwatch(onDone);\n\t\tconst start = Date.now();\n\n\t\t/* __GDPR__\n\t\t\t\"searchResultsFinished\" : {\n\t\t\t\t\"duration\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\", \"isMeasurement\": true }\n\t\t\t}\n\t\t*/\n\t\tonDoneStopwatch(duration => this.telemetryService.publicLog('searchResultsFinished', { duration }));\n\n\t\tcurrentRequest.then(\n\t\t\tvalue => this.onSearchCompleted(value, Date.now() - start),\n\t\t\te => this.onSearchError(e, Date.now() - start));\n\n\t\treturn currentRequest;\n\t}\n\n\tprivate onSearchCompleted(completed: ISearchComplete | null, duration: number): ISearchComplete | null {\n\t\tif (!this._searchQuery) {\n\t\t\tthrow new Error('onSearchCompleted must be called after a search is started');\n\t\t}\n\n\t\tconst options: IPatternInfo = objects.assign({}, this._searchQuery.contentPattern);\n\t\tdelete options.pattern;\n\n\t\tconst stats = completed && completed.stats as ITextSearchStats;\n\n\t\tconst fileSchemeOnly = this._searchQuery.folderQueries.every(fq => fq.folder.scheme === 'file');\n\t\tconst otherSchemeOnly = this._searchQuery.folderQueries.every(fq => fq.folder.scheme !== 'file');\n\t\tconst scheme = fileSchemeOnly ? 'file' :\n\t\t\totherSchemeOnly ? 'other' :\n\t\t\t\t'mixed';\n\n\t\t/* __GDPR__\n\t\t\t\"searchResultsShown\" : {\n\t\t\t\t\"count\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\", \"isMeasurement\": true },\n\t\t\t\t\"fileCount\": { \"classification\": \"SystemMetaData\", \"purpose\": \"FeatureInsight\", \"isMeasurement\": true },\n\t\t\t\t\"options\": { \"${inline}\": [ \"${IPatternInfo}\" ] },\n\t\t\t\t\"duration\": { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\", \"isMeasurement\": true },\n\t\t\t\t\"type\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\" },\n\t\t\t\t\"scheme\" : { \"classification\": \"SystemMetaData\", \"purpose\": \"PerformanceAndHealth\" }\n\t\t\t}\n\t\t*/\n\t\tthis.telemetryService.publicLog('searchResultsShown', {\n\t\t\tcount: this._searchResult.count(),\n\t\t\tfileCount: this._searchResult.fileCount(),\n\t\t\toptions,\n\t\t\tduration,\n\t\t\ttype: stats && stats.type,\n\t\t\tscheme\n\t\t});\n\t\treturn completed;\n\t}\n\n\tprivate onSearchError(e: any, duration: number): void {\n\t\tif (errors.isPromiseCanceledError(e)) {\n\t\t\tthis.onSearchCompleted(null, duration);\n\t\t}\n\t}\n\n\tprivate onSearchProgress(p: ISearchProgressItem): void {\n\t\tif ((<IFileMatch>p).resource) {\n\t\t\tthis._searchResult.add([<IFileMatch>p], true);\n\t\t}\n\t}\n\n\tcancelSearch(): boolean {\n\t\tif (this.currentCancelTokenSource) {\n\t\t\tthis.currentCancelTokenSource.cancel();\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tdispose(): void {\n\t\tthis.cancelSearch();\n\t\tthis.searchResult.dispose();\n\t\tsuper.dispose();\n\t}\n}\n\nexport type FileMatchOrMatch = FileMatch | Match;\n\nexport type RenderableMatch = BaseFolderMatch | FolderMatch | FileMatch | Match;\n\nexport class SearchWorkbenchService implements ISearchWorkbenchService {\n\n\t_serviceBrand: any;\n\tprivate _searchModel: SearchModel;\n\n\tconstructor(@IInstantiationService private readonly instantiationService: IInstantiationService) {\n\t}\n\n\tget searchModel(): SearchModel {\n\t\tif (!this._searchModel) {\n\t\t\tthis._searchModel = this.instantiationService.createInstance(SearchModel);\n\t\t}\n\t\treturn this._searchModel;\n\t}\n}\n\nexport const ISearchWorkbenchService = createDecorator<ISearchWorkbenchService>('searchWorkbenchService');\n\nexport interface ISearchWorkbenchService {\n\t_serviceBrand: any;\n\n\treadonly searchModel: SearchModel;\n}\n\n/**\n * Can add a range highlight decoration to a model.\n * It will automatically remove it when the model has its decorations changed.\n */\nexport class RangeHighlightDecorations implements IDisposable {\n\n\tprivate _decorationId: string | null = null;\n\tprivate _model: ITextModel | null = null;\n\tprivate _modelDisposables: IDisposable[] = [];\n\n\tconstructor(\n\t\t@IModelService private readonly _modelService: IModelService\n\t) {\n\t}\n\n\tremoveHighlightRange() {\n\t\tif (this._model && this._decorationId) {\n\t\t\tthis._model.deltaDecorations([this._decorationId], []);\n\t\t}\n\t\tthis._decorationId = null;\n\t}\n\n\thighlightRange(resource: URI | ITextModel, range: Range, ownerId: number = 0): void {\n\t\tlet model: ITextModel | null;\n\t\tif (URI.isUri(resource)) {\n\t\t\tmodel = this._modelService.getModel(resource);\n\t\t} else {\n\t\t\tmodel = resource;\n\t\t}\n\n\t\tif (model) {\n\t\t\tthis.doHighlightRange(model, range);\n\t\t}\n\t}\n\n\tprivate doHighlightRange(model: ITextModel, range: Range) {\n\t\tthis.removeHighlightRange();\n\t\tthis._decorationId = model.deltaDecorations([], [{ range: range, options: RangeHighlightDecorations._RANGE_HIGHLIGHT_DECORATION }])[0];\n\t\tthis.setModel(model);\n\t}\n\n\tprivate setModel(model: ITextModel) {\n\t\tif (this._model !== model) {\n\t\t\tthis.disposeModelListeners();\n\t\t\tthis._model = model;\n\t\t\tthis._modelDisposables.push(this._model.onDidChangeDecorations((e) => {\n\t\t\t\tthis.disposeModelListeners();\n\t\t\t\tthis.removeHighlightRange();\n\t\t\t\tthis._model = null;\n\t\t\t}));\n\t\t\tthis._modelDisposables.push(this._model.onWillDispose(() => {\n\t\t\t\tthis.disposeModelListeners();\n\t\t\t\tthis.removeHighlightRange();\n\t\t\t\tthis._model = null;\n\t\t\t}));\n\t\t}\n\t}\n\n\tprivate disposeModelListeners() {\n\t\tthis._modelDisposables.forEach(disposable => disposable.dispose());\n\t\tthis._modelDisposables = [];\n\t}\n\n\tdispose() {\n\t\tif (this._model) {\n\t\t\tthis.removeHighlightRange();\n\t\t\tthis.disposeModelListeners();\n\t\t\tthis._model = null;\n\t\t}\n\t}\n\n\tprivate static readonly _RANGE_HIGHLIGHT_DECORATION = ModelDecorationOptions.register({\n\t\tstickiness: TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,\n\t\tclassName: 'rangeHighlight',\n\t\tisWholeLine: true\n\t});\n}\n\nfunction textSearchResultToMatches(rawMatch: ITextSearchMatch, fileMatch: FileMatch): Match[] {\n\tconst previewLines = rawMatch.preview.text.split('\\n');\n\tif (Array.isArray(rawMatch.ranges)) {\n\t\treturn rawMatch.ranges.map((r, i) => {\n\t\t\tconst previewRange: ISearchRange = rawMatch.preview.matches[i];\n\t\t\treturn new Match(fileMatch, previewLines, previewRange, r);\n\t\t});\n\t} else {\n\t\tconst previewRange = <ISearchRange>rawMatch.preview.matches;\n\t\tconst match = new Match(fileMatch, previewLines, previewRange, rawMatch.ranges);\n\t\treturn [match];\n\t}\n}\n"]}]}