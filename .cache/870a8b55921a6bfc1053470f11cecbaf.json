{"remainingRequest":"/home/coding/workspace/node_modules/ts-loader/index.js?{\"happyPackMode\":true,\"compilerOptions\":{\"target\":\"es5\",\"lib\":[\"dom\",\"esnext\"]}}!/home/coding/workspace/lib/vscode/src/vs/workbench/contrib/comments/browser/commentThreadWidget.ts","dependencies":[{"path":"/home/coding/workspace/lib/vscode/src/vs/workbench/contrib/comments/browser/commentThreadWidget.ts","mtime":1555102317000},{"path":"/home/coding/workspace/node_modules/cache-loader/dist/cjs.js","mtime":1555844183884},{"path":"/home/coding/workspace/node_modules/ts-loader/index.js","mtime":1555844217316}],"contextDependencies":[],"result":["\"use strict\";\n/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar tslib_1 = require(\"tslib\");\nvar nls = require(\"vs/nls\");\nvar dom = require(\"vs/base/browser/dom\");\nvar actionbar_1 = require(\"vs/base/browser/ui/actionbar/actionbar\");\nvar button_1 = require(\"vs/base/browser/ui/button/button\");\nvar actions_1 = require(\"vs/base/common/actions\");\nvar arrays = require(\"vs/base/common/arrays\");\nvar color_1 = require(\"vs/base/common/color\");\nvar event_1 = require(\"vs/base/common/event\");\nvar lifecycle_1 = require(\"vs/base/common/lifecycle\");\nvar strings = require(\"vs/base/common/strings\");\nvar editorBrowser_1 = require(\"vs/editor/browser/editorBrowser\");\nvar modes = require(\"vs/editor/common/modes\");\nvar referencesWidget_1 = require(\"vs/editor/contrib/referenceSearch/referencesWidget\");\nvar zoneWidget_1 = require(\"vs/editor/contrib/zoneWidget/zoneWidget\");\nvar styler_1 = require(\"vs/platform/theme/common/styler\");\nvar themeService_1 = require(\"vs/platform/theme/common/themeService\");\nvar commentGlyphWidget_1 = require(\"vs/workbench/contrib/comments/browser/commentGlyphWidget\");\nvar instantiation_1 = require(\"vs/platform/instantiation/common/instantiation\");\nvar modelService_1 = require(\"vs/editor/common/services/modelService\");\nvar simpleCommentEditor_1 = require(\"./simpleCommentEditor\");\nvar uri_1 = require(\"vs/base/common/uri\");\nvar colorRegistry_1 = require(\"vs/platform/theme/common/colorRegistry\");\nvar modeService_1 = require(\"vs/editor/common/services/modeService\");\nvar commentService_1 = require(\"vs/workbench/contrib/comments/browser/commentService\");\nvar range_1 = require(\"vs/editor/common/core/range\");\nvar opener_1 = require(\"vs/platform/opener/common/opener\");\nvar markdownRenderer_1 = require(\"vs/editor/contrib/markdown/markdownRenderer\");\nvar commentNode_1 = require(\"vs/workbench/contrib/comments/browser/commentNode\");\nvar commands_1 = require(\"vs/platform/commands/common/commands\");\nvar uuid_1 = require(\"vs/base/common/uuid\");\nvar types_1 = require(\"vs/base/common/types\");\nexports.COMMENTEDITOR_DECORATION_KEY = 'commenteditordecoration';\nvar COLLAPSE_ACTION_CLASS = 'expand-review-action octicon octicon-x';\nvar COMMENT_SCHEME = 'comment';\nvar INMEM_MODEL_ID = 0;\nvar ReviewZoneWidget = /** @class */ (function (_super) {\n    tslib_1.__extends(ReviewZoneWidget, _super);\n    function ReviewZoneWidget(editor, _owner, _commentThread, _pendingComment, _draftMode, instantiationService, modeService, commandService, modelService, themeService, commentService, openerService) {\n        var _this = _super.call(this, editor, { keepEditorSelection: true }) || this;\n        _this._owner = _owner;\n        _this._commentThread = _commentThread;\n        _this._pendingComment = _pendingComment;\n        _this._draftMode = _draftMode;\n        _this.instantiationService = instantiationService;\n        _this.modeService = modeService;\n        _this.commandService = commandService;\n        _this.modelService = modelService;\n        _this.themeService = themeService;\n        _this.commentService = commentService;\n        _this.openerService = openerService;\n        _this._onDidClose = new event_1.Emitter();\n        _this._onDidCreateThread = new event_1.Emitter();\n        _this._resizeObserver = null;\n        _this._isCollapsed = _commentThread.collapsibleState !== modes.CommentThreadCollapsibleState.Expanded;\n        _this._globalToDispose = [];\n        _this._submitActionsDisposables = [];\n        _this._formActions = null;\n        _this.create();\n        _this._styleElement = dom.createStyleSheet(_this.domNode);\n        _this._globalToDispose.push(_this.themeService.onThemeChange(_this._applyTheme, _this));\n        _this._globalToDispose.push(_this.editor.onDidChangeConfiguration(function (e) {\n            if (e.fontInfo) {\n                _this._applyTheme(_this.themeService.getTheme());\n            }\n        }));\n        _this._applyTheme(_this.themeService.getTheme());\n        _this._markdownRenderer = new markdownRenderer_1.MarkdownRenderer(editor, _this.modeService, _this.openerService);\n        _this._parentEditor = editor;\n        return _this;\n    }\n    Object.defineProperty(ReviewZoneWidget.prototype, \"owner\", {\n        get: function () {\n            return this._owner;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(ReviewZoneWidget.prototype, \"commentThread\", {\n        get: function () {\n            return this._commentThread;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(ReviewZoneWidget.prototype, \"extensionId\", {\n        get: function () {\n            return this._commentThread.extensionId;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(ReviewZoneWidget.prototype, \"draftMode\", {\n        get: function () {\n            return this._draftMode;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(ReviewZoneWidget.prototype, \"onDidClose\", {\n        get: function () {\n            return this._onDidClose.event;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    Object.defineProperty(ReviewZoneWidget.prototype, \"onDidCreateThread\", {\n        get: function () {\n            return this._onDidCreateThread.event;\n        },\n        enumerable: true,\n        configurable: true\n    });\n    ReviewZoneWidget.prototype.getPosition = function () {\n        if (this.position) {\n            return this.position;\n        }\n        if (this._commentGlyph) {\n            return types_1.withNullAsUndefined(this._commentGlyph.getPosition().position);\n        }\n        return undefined;\n    };\n    ReviewZoneWidget.prototype.revealLine = function (lineNumber) {\n        // we don't do anything here as we always do the reveal ourselves.\n    };\n    ReviewZoneWidget.prototype.reveal = function (commentId) {\n        if (this._isCollapsed) {\n            this.show({ lineNumber: this._commentThread.range.startLineNumber, column: 1 }, 2);\n        }\n        if (commentId) {\n            var height = this.editor.getLayoutInfo().height;\n            var matchedNode = this._commentElements.filter(function (commentNode) { return commentNode.comment.commentId === commentId; });\n            if (matchedNode && matchedNode.length) {\n                var commentThreadCoords = dom.getDomNodePagePosition(this._commentElements[0].domNode);\n                var commentCoords = dom.getDomNodePagePosition(matchedNode[0].domNode);\n                this.editor.setScrollTop(this.editor.getTopForLineNumber(this._commentThread.range.startLineNumber) - height / 2 + commentCoords.top - commentThreadCoords.top);\n                return;\n            }\n        }\n        this.editor.revealRangeInCenter(this._commentThread.range);\n    };\n    ReviewZoneWidget.prototype.getPendingComment = function () {\n        if (this._commentEditor) {\n            var model = this._commentEditor.getModel();\n            if (model && model.getValueLength() > 0) { // checking length is cheap\n                return model.getValue();\n            }\n        }\n        return null;\n    };\n    ReviewZoneWidget.prototype._fillContainer = function (container) {\n        var _this = this;\n        this.setCssClass('review-widget');\n        this._headElement = dom.$('.head');\n        container.appendChild(this._headElement);\n        this._fillHead(this._headElement);\n        this._bodyElement = dom.$('.body');\n        container.appendChild(this._bodyElement);\n        dom.addDisposableListener(this._bodyElement, dom.EventType.FOCUS_IN, function (e) {\n            _this.commentService.setActiveCommentThread(_this._commentThread);\n        });\n    };\n    ReviewZoneWidget.prototype._fillHead = function (container) {\n        var _this = this;\n        var titleElement = dom.append(this._headElement, dom.$('.review-title'));\n        this._headingLabel = dom.append(titleElement, dom.$('span.filename'));\n        this.createThreadLabel();\n        var actionsContainer = dom.append(this._headElement, dom.$('.review-actions'));\n        this._actionbarWidget = new actionbar_1.ActionBar(actionsContainer, {});\n        this._disposables.push(this._actionbarWidget);\n        this._collapseAction = new actions_1.Action('review.expand', nls.localize('label.collapse', \"Collapse\"), COLLAPSE_ACTION_CLASS, true, function () { return _this.collapse(); });\n        this._actionbarWidget.push(this._collapseAction, { label: false, icon: true });\n    };\n    ReviewZoneWidget.prototype.collapse = function () {\n        var _a;\n        if (this._commentThread.comments.length === 0) {\n            if (this._commentThread.commentThreadHandle === undefined) {\n                this.dispose();\n                return Promise.resolve();\n            }\n            else {\n                var deleteCommand = this._commentThread.deleteCommand;\n                if (deleteCommand) {\n                    return (_a = this.commandService).executeCommand.apply(_a, [deleteCommand.id].concat((deleteCommand.arguments || [])));\n                }\n            }\n        }\n        this._isCollapsed = true;\n        this.hide();\n        return Promise.resolve();\n    };\n    ReviewZoneWidget.prototype.getGlyphPosition = function () {\n        if (this._commentGlyph) {\n            return this._commentGlyph.getPosition().position.lineNumber;\n        }\n        return 0;\n    };\n    ReviewZoneWidget.prototype.toggleExpand = function (lineNumber) {\n        if (this._isCollapsed) {\n            this.show({ lineNumber: lineNumber, column: 1 }, 2);\n        }\n        else {\n            this.hide();\n            if (this._commentThread === null || this._commentThread.threadId === null) {\n                this.dispose();\n            }\n        }\n    };\n    ReviewZoneWidget.prototype.update = function (commentThread) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var oldCommentsLen, newCommentsLen, commentElementsToDel, commentElementsToDelIndex, _loop_1, this_1, i, i, lastCommentElement, newCommentNodeList, _loop_2, this_2, i, lineNumber, shouldMoveWidget;\n            return tslib_1.__generator(this, function (_a) {\n                oldCommentsLen = this._commentElements.length;\n                newCommentsLen = commentThread.comments.length;\n                commentElementsToDel = [];\n                commentElementsToDelIndex = [];\n                _loop_1 = function (i) {\n                    var comment = this_1._commentElements[i].comment;\n                    var newComment = commentThread.comments.filter(function (c) { return c.commentId === comment.commentId; });\n                    if (newComment.length) {\n                        this_1._commentElements[i].update(newComment[0]);\n                    }\n                    else {\n                        commentElementsToDelIndex.push(i);\n                        commentElementsToDel.push(this_1._commentElements[i]);\n                    }\n                };\n                this_1 = this;\n                for (i = 0; i < oldCommentsLen; i++) {\n                    _loop_1(i);\n                }\n                // del removed elements\n                for (i = commentElementsToDel.length - 1; i >= 0; i--) {\n                    this._commentElements.splice(commentElementsToDelIndex[i], 1);\n                    this._commentsElement.removeChild(commentElementsToDel[i].domNode);\n                }\n                lastCommentElement = null;\n                newCommentNodeList = [];\n                _loop_2 = function (i) {\n                    var currentComment = commentThread.comments[i];\n                    var oldCommentNode = this_2._commentElements.filter(function (commentNode) { return commentNode.comment.commentId === currentComment.commentId; });\n                    if (oldCommentNode.length) {\n                        oldCommentNode[0].update(currentComment);\n                        lastCommentElement = oldCommentNode[0].domNode;\n                        newCommentNodeList.unshift(oldCommentNode[0]);\n                    }\n                    else {\n                        var newElement = this_2.createNewCommentNode(currentComment);\n                        newCommentNodeList.unshift(newElement);\n                        if (lastCommentElement) {\n                            this_2._commentsElement.insertBefore(newElement.domNode, lastCommentElement);\n                            lastCommentElement = newElement.domNode;\n                        }\n                        else {\n                            this_2._commentsElement.appendChild(newElement.domNode);\n                            lastCommentElement = newElement.domNode;\n                        }\n                    }\n                };\n                this_2 = this;\n                for (i = newCommentsLen - 1; i >= 0; i--) {\n                    _loop_2(i);\n                }\n                this._commentThread = commentThread;\n                this._commentElements = newCommentNodeList;\n                this.createThreadLabel();\n                lineNumber = this._commentThread.range.startLineNumber;\n                shouldMoveWidget = false;\n                if (this._commentGlyph) {\n                    if (this._commentGlyph.getPosition().position.lineNumber !== lineNumber) {\n                        shouldMoveWidget = true;\n                        this._commentGlyph.setLineNumber(lineNumber);\n                    }\n                }\n                if (!this._reviewThreadReplyButton) {\n                    this.createReplyButton();\n                }\n                if (shouldMoveWidget && !this._isCollapsed) {\n                    this.show({ lineNumber: lineNumber, column: 1 }, 2);\n                }\n                return [2 /*return*/];\n            });\n        });\n    };\n    ReviewZoneWidget.prototype.updateDraftMode = function (draftMode) {\n        if (this._draftMode !== draftMode) {\n            this._draftMode = draftMode;\n            if (this._formActions && this._commentEditor.hasModel()) {\n                var model = this._commentEditor.getModel();\n                dom.clearNode(this._formActions);\n                this.createCommentWidgetActions(this._formActions, model);\n            }\n        }\n    };\n    ReviewZoneWidget.prototype._onWidth = function (widthInPixel) {\n        this._commentEditor.layout({ height: 5 * 18, width: widthInPixel - 54 /* margin 20px * 10 + scrollbar 14px*/ });\n    };\n    ReviewZoneWidget.prototype._doLayout = function (heightInPixel, widthInPixel) {\n        this._commentEditor.layout({ height: 5 * 18, width: widthInPixel - 54 /* margin 20px * 10 + scrollbar 14px*/ });\n    };\n    ReviewZoneWidget.prototype.display = function (lineNumber) {\n        var _this = this;\n        this._commentGlyph = new commentGlyphWidget_1.CommentGlyphWidget(this.editor, lineNumber);\n        this._disposables.push(this.editor.onMouseDown(function (e) { return _this.onEditorMouseDown(e); }));\n        this._disposables.push(this.editor.onMouseUp(function (e) { return _this.onEditorMouseUp(e); }));\n        var headHeight = Math.ceil(this.editor.getConfiguration().lineHeight * 1.2);\n        this._headElement.style.height = headHeight + \"px\";\n        this._headElement.style.lineHeight = this._headElement.style.height;\n        this._commentsElement = dom.append(this._bodyElement, dom.$('div.comments-container'));\n        this._commentsElement.setAttribute('role', 'presentation');\n        this._commentElements = [];\n        for (var _i = 0, _a = this._commentThread.comments; _i < _a.length; _i++) {\n            var comment = _a[_i];\n            var newCommentNode = this.createNewCommentNode(comment);\n            this._commentElements.push(newCommentNode);\n            this._commentsElement.appendChild(newCommentNode.domNode);\n        }\n        var hasExistingComments = this._commentThread.comments.length > 0;\n        this._commentForm = dom.append(this._bodyElement, dom.$('.comment-form'));\n        this._commentEditor = this.instantiationService.createInstance(simpleCommentEditor_1.SimpleCommentEditor, this._commentForm, simpleCommentEditor_1.SimpleCommentEditor.getEditorOptions(), this._parentEditor, this);\n        var modeId = uuid_1.generateUuid() + '-' + (hasExistingComments ? this._commentThread.threadId : ++INMEM_MODEL_ID);\n        var params = JSON.stringify({\n            extensionId: this.extensionId,\n            commentThreadId: this.commentThread.threadId\n        });\n        var resource = uri_1.URI.parse(COMMENT_SCHEME + \":commentinput-\" + modeId + \".md?\" + params);\n        var model = this.modelService.createModel(this._pendingComment || '', this.modeService.createByFilepathOrFirstLine(resource.path), resource, false);\n        this._disposables.push(model);\n        this._commentEditor.setModel(model);\n        this._disposables.push(this._commentEditor);\n        this._disposables.push(this._commentEditor.getModel().onDidChangeContent(function () { return _this.setCommentEditorDecorations(); }));\n        if (this._commentThread.commentThreadHandle !== undefined) {\n            this._disposables.push(this._commentEditor.onDidFocusEditorWidget(function () {\n                var commentThread = _this._commentThread;\n                commentThread.input = {\n                    uri: _this._commentEditor.getModel().uri,\n                    value: _this._commentEditor.getValue()\n                };\n                _this.commentService.setActiveCommentThread(_this._commentThread);\n            }));\n            this._disposables.push(this._commentEditor.getModel().onDidChangeContent(function () {\n                var modelContent = _this._commentEditor.getValue();\n                var thread = _this._commentThread;\n                if (thread.input && thread.input.uri === _this._commentEditor.getModel().uri && thread.input.value !== modelContent) {\n                    var newInput = thread.input;\n                    newInput.value = modelContent;\n                    thread.input = newInput;\n                }\n            }));\n            this._disposables.push(this._commentThread.onDidChangeInput(function (input) {\n                var thread = _this._commentThread;\n                if (thread.input && thread.input.uri !== _this._commentEditor.getModel().uri) {\n                    return;\n                }\n                if (!input) {\n                    return;\n                }\n                if (_this._commentEditor.getValue() !== input.value) {\n                    _this._commentEditor.setValue(input.value);\n                    if (input.value === '') {\n                        _this._pendingComment = '';\n                        if (dom.hasClass(_this._commentForm, 'expand')) {\n                            dom.removeClass(_this._commentForm, 'expand');\n                        }\n                        _this._commentEditor.getDomNode().style.outline = '';\n                        _this._error.textContent = '';\n                        dom.addClass(_this._error, 'hidden');\n                    }\n                }\n            }));\n            this._disposables.push(this._commentThread.onDidChangeComments(function (_) { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0: return [4 /*yield*/, this.update(this._commentThread)];\n                        case 1:\n                            _a.sent();\n                            return [2 /*return*/];\n                    }\n                });\n            }); }));\n            this._disposables.push(this._commentThread.onDidChangeLabel(function (_) {\n                _this.createThreadLabel();\n            }));\n        }\n        this.setCommentEditorDecorations();\n        // Only add the additional step of clicking a reply button to expand the textarea when there are existing comments\n        if (hasExistingComments) {\n            this.createReplyButton();\n        }\n        else {\n            if (!dom.hasClass(this._commentForm, 'expand')) {\n                dom.addClass(this._commentForm, 'expand');\n                this._commentEditor.focus();\n            }\n        }\n        this._error = dom.append(this._commentForm, dom.$('.validation-error.hidden'));\n        this._formActions = dom.append(this._commentForm, dom.$('.form-actions'));\n        if (this._commentThread.commentThreadHandle !== undefined) {\n            this.createCommentWidgetActions2(this._formActions, model);\n            this._disposables.push(this._commentThread.onDidChangeAcceptInputCommand(function (_) {\n                if (_this._formActions) {\n                    dom.clearNode(_this._formActions);\n                    _this.createCommentWidgetActions2(_this._formActions, model);\n                }\n            }));\n            this._disposables.push(this._commentThread.onDidChangeAdditionalCommands(function (_) {\n                if (_this._formActions) {\n                    dom.clearNode(_this._formActions);\n                    _this.createCommentWidgetActions2(_this._formActions, model);\n                }\n            }));\n            this._disposables.push(this._commentThread.onDidChangeRange(function (range) {\n                // Move comment glyph widget and show position if the line has changed.\n                var lineNumber = _this._commentThread.range.startLineNumber;\n                var shouldMoveWidget = false;\n                if (_this._commentGlyph) {\n                    if (_this._commentGlyph.getPosition().position.lineNumber !== lineNumber) {\n                        shouldMoveWidget = true;\n                        _this._commentGlyph.setLineNumber(lineNumber);\n                    }\n                }\n                if (shouldMoveWidget && !_this._isCollapsed) {\n                    _this.show({ lineNumber: lineNumber, column: 1 }, 2);\n                }\n            }));\n            this._disposables.push(this._commentThread.onDidChangeCollasibleState(function (state) {\n                if (state === modes.CommentThreadCollapsibleState.Expanded && _this._isCollapsed) {\n                    var lineNumber_1 = _this._commentThread.range.startLineNumber;\n                    _this.show({ lineNumber: lineNumber_1, column: 1 }, 2);\n                    return;\n                }\n                if (state === modes.CommentThreadCollapsibleState.Collapsed && !_this._isCollapsed) {\n                    _this.hide();\n                    return;\n                }\n            }));\n        }\n        else {\n            this.createCommentWidgetActions(this._formActions, model);\n        }\n        this._resizeObserver = new MutationObserver(this._refresh.bind(this));\n        this._resizeObserver.observe(this._bodyElement, {\n            attributes: true,\n            childList: true,\n            characterData: true,\n            subtree: true\n        });\n        if (this._commentThread.collapsibleState === modes.CommentThreadCollapsibleState.Expanded) {\n            this.show({ lineNumber: lineNumber, column: 1 }, 2);\n        }\n        // If there are no existing comments, place focus on the text area. This must be done after show, which also moves focus.\n        if (this._commentThread.reply && !this._commentThread.comments.length) {\n            this._commentEditor.focus();\n        }\n        else if (this._commentEditor.getModel().getValueLength() > 0) {\n            if (!dom.hasClass(this._commentForm, 'expand')) {\n                dom.addClass(this._commentForm, 'expand');\n            }\n            this._commentEditor.focus();\n        }\n    };\n    ReviewZoneWidget.prototype.handleError = function (e) {\n        this._error.textContent = e.message;\n        this._commentEditor.getDomNode().style.outline = \"1px solid \" + this.themeService.getTheme().getColor(colorRegistry_1.inputValidationErrorBorder);\n        dom.removeClass(this._error, 'hidden');\n    };\n    ReviewZoneWidget.prototype.getActiveComment = function () {\n        return this._commentElements.filter(function (node) { return node.isEditing; })[0] || this;\n    };\n    ReviewZoneWidget.prototype.createCommentWidgetActions = function (container, model) {\n        var _this = this;\n        lifecycle_1.dispose(this._submitActionsDisposables);\n        var button = new button_1.Button(container);\n        this._submitActionsDisposables.push(styler_1.attachButtonStyler(button, this.themeService));\n        button.label = 'Add comment';\n        button.enabled = model.getValueLength() > 0;\n        this._submitActionsDisposables.push(this._commentEditor.onDidChangeModelContent(function (_) {\n            if (_this._commentEditor.getValue()) {\n                button.enabled = true;\n            }\n            else {\n                button.enabled = false;\n            }\n        }));\n        button.onDidClick(function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                this.createComment();\n                return [2 /*return*/];\n            });\n        }); });\n        if (this._draftMode === modes.DraftMode.NotSupported) {\n            return;\n        }\n        switch (this._draftMode) {\n            case modes.DraftMode.InDraft:\n                var deleteDraftLabel = this.commentService.getDeleteDraftLabel(this._owner);\n                if (deleteDraftLabel) {\n                    var deletedraftButton = new button_1.Button(container);\n                    this._submitActionsDisposables.push(styler_1.attachButtonStyler(deletedraftButton, this.themeService));\n                    deletedraftButton.label = deleteDraftLabel;\n                    deletedraftButton.enabled = true;\n                    this._disposables.push(deletedraftButton.onDidClick(function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                        var e_1;\n                        return tslib_1.__generator(this, function (_a) {\n                            switch (_a.label) {\n                                case 0:\n                                    _a.trys.push([0, 2, , 3]);\n                                    return [4 /*yield*/, this.commentService.deleteDraft(this._owner, this.editor.getModel().uri)];\n                                case 1:\n                                    _a.sent();\n                                    return [3 /*break*/, 3];\n                                case 2:\n                                    e_1 = _a.sent();\n                                    this.handleError(e_1);\n                                    return [3 /*break*/, 3];\n                                case 3: return [2 /*return*/];\n                            }\n                        });\n                    }); }));\n                }\n                var submitDraftLabel = this.commentService.getFinishDraftLabel(this._owner);\n                if (submitDraftLabel) {\n                    var submitdraftButton = new button_1.Button(container);\n                    this._submitActionsDisposables.push(styler_1.attachButtonStyler(submitdraftButton, this.themeService));\n                    submitdraftButton.label = this.commentService.getFinishDraftLabel(this._owner);\n                    submitdraftButton.enabled = true;\n                    submitdraftButton.onDidClick(function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                        var e_2;\n                        return tslib_1.__generator(this, function (_a) {\n                            switch (_a.label) {\n                                case 0:\n                                    _a.trys.push([0, 4, , 5]);\n                                    if (!this._commentEditor.getValue()) return [3 /*break*/, 2];\n                                    return [4 /*yield*/, this.createComment()];\n                                case 1:\n                                    _a.sent();\n                                    _a.label = 2;\n                                case 2: return [4 /*yield*/, this.commentService.finishDraft(this._owner, this.editor.getModel().uri)];\n                                case 3:\n                                    _a.sent();\n                                    return [3 /*break*/, 5];\n                                case 4:\n                                    e_2 = _a.sent();\n                                    this.handleError(e_2);\n                                    return [3 /*break*/, 5];\n                                case 5: return [2 /*return*/];\n                            }\n                        });\n                    }); });\n                }\n                break;\n            case modes.DraftMode.NotInDraft:\n                var startDraftLabel = this.commentService.getStartDraftLabel(this._owner);\n                if (startDraftLabel) {\n                    var draftButton_1 = new button_1.Button(container);\n                    this._disposables.push(styler_1.attachButtonStyler(draftButton_1, this.themeService));\n                    draftButton_1.label = this.commentService.getStartDraftLabel(this._owner);\n                    draftButton_1.enabled = model.getValueLength() > 0;\n                    this._submitActionsDisposables.push(this._commentEditor.onDidChangeModelContent(function (_) {\n                        if (_this._commentEditor.getValue()) {\n                            draftButton_1.enabled = true;\n                        }\n                        else {\n                            draftButton_1.enabled = false;\n                        }\n                    }));\n                    this._disposables.push(draftButton_1.onDidClick(function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                        var e_3;\n                        return tslib_1.__generator(this, function (_a) {\n                            switch (_a.label) {\n                                case 0:\n                                    _a.trys.push([0, 3, , 4]);\n                                    return [4 /*yield*/, this.commentService.startDraft(this._owner, this.editor.getModel().uri)];\n                                case 1:\n                                    _a.sent();\n                                    return [4 /*yield*/, this.createComment()];\n                                case 2:\n                                    _a.sent();\n                                    return [3 /*break*/, 4];\n                                case 3:\n                                    e_3 = _a.sent();\n                                    this.handleError(e_3);\n                                    return [3 /*break*/, 4];\n                                case 4: return [2 /*return*/];\n                            }\n                        });\n                    }); }));\n                }\n                break;\n        }\n    };\n    /**\n     * Command based actions.\n     */\n    ReviewZoneWidget.prototype.createCommentWidgetActions2 = function (container, model) {\n        var _this = this;\n        var commentThread = this._commentThread;\n        var acceptInputCommand = commentThread.acceptInputCommand;\n        if (acceptInputCommand) {\n            var button_2 = new button_1.Button(container);\n            this._disposables.push(styler_1.attachButtonStyler(button_2, this.themeService));\n            button_2.label = acceptInputCommand.title;\n            this._disposables.push(button_2.onDidClick(function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                var _a;\n                return tslib_1.__generator(this, function (_b) {\n                    switch (_b.label) {\n                        case 0:\n                            commentThread.input = {\n                                uri: this._commentEditor.getModel().uri,\n                                value: this._commentEditor.getValue()\n                            };\n                            this.commentService.setActiveCommentThread(this._commentThread);\n                            return [4 /*yield*/, (_a = this.commandService).executeCommand.apply(_a, [acceptInputCommand.id].concat((acceptInputCommand.arguments || [])))];\n                        case 1:\n                            _b.sent();\n                            return [2 /*return*/];\n                    }\n                });\n            }); }));\n            button_2.enabled = model.getValueLength() > 0;\n            this._disposables.push(this._commentEditor.onDidChangeModelContent(function (_) {\n                if (_this._commentEditor.getValue()) {\n                    button_2.enabled = true;\n                }\n                else {\n                    button_2.enabled = false;\n                }\n            }));\n        }\n        commentThread.additionalCommands.reverse().forEach(function (command) {\n            var button = new button_1.Button(container);\n            _this._disposables.push(styler_1.attachButtonStyler(button, _this.themeService));\n            button.label = command.title;\n            _this._disposables.push(button.onDidClick(function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                var _a;\n                return tslib_1.__generator(this, function (_b) {\n                    switch (_b.label) {\n                        case 0:\n                            commentThread.input = {\n                                uri: this._commentEditor.getModel().uri,\n                                value: this._commentEditor.getValue()\n                            };\n                            this.commentService.setActiveCommentThread(this._commentThread);\n                            return [4 /*yield*/, (_a = this.commandService).executeCommand.apply(_a, [command.id].concat((command.arguments || [])))];\n                        case 1:\n                            _b.sent();\n                            return [2 /*return*/];\n                    }\n                });\n            }); }));\n        });\n    };\n    ReviewZoneWidget.prototype.createNewCommentNode = function (comment) {\n        var _this = this;\n        var newCommentNode = this.instantiationService.createInstance(commentNode_1.CommentNode, this._commentThread, comment, this.owner, this.editor.getModel().uri, this._parentEditor, this, this._markdownRenderer);\n        this._disposables.push(newCommentNode);\n        this._disposables.push(newCommentNode.onDidDelete(function (deletedNode) {\n            var deletedNodeId = deletedNode.comment.commentId;\n            var deletedElementIndex = arrays.firstIndex(_this._commentElements, function (commentNode) { return commentNode.comment.commentId === deletedNodeId; });\n            if (deletedElementIndex > -1) {\n                _this._commentElements.splice(deletedElementIndex, 1);\n            }\n            var deletedCommentIndex = arrays.firstIndex(_this._commentThread.comments, function (comment) { return comment.commentId === deletedNodeId; });\n            if (deletedCommentIndex > -1) {\n                _this._commentThread.comments.splice(deletedCommentIndex, 1);\n            }\n            _this._commentsElement.removeChild(deletedNode.domNode);\n            deletedNode.dispose();\n            if (_this._commentThread.comments.length === 0) {\n                _this.dispose();\n            }\n        }));\n        return newCommentNode;\n    };\n    ReviewZoneWidget.prototype.submitComment = function () {\n        return tslib_1.__awaiter(this, void 0, Promise, function () {\n            var _a, activeComment, commentThread, commandId, args;\n            return tslib_1.__generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        activeComment = this.getActiveComment();\n                        if (!(activeComment instanceof ReviewZoneWidget)) return [3 /*break*/, 4];\n                        if (!(this._commentThread.commentThreadHandle !== undefined)) return [3 /*break*/, 3];\n                        commentThread = this._commentThread;\n                        if (!commentThread.acceptInputCommand) return [3 /*break*/, 2];\n                        commentThread.input = {\n                            uri: this._commentEditor.getModel().uri,\n                            value: this._commentEditor.getValue()\n                        };\n                        this.commentService.setActiveCommentThread(this._commentThread);\n                        commandId = commentThread.acceptInputCommand.id;\n                        args = commentThread.acceptInputCommand.arguments || [];\n                        return [4 /*yield*/, (_a = this.commandService).executeCommand.apply(_a, [commandId].concat(args))];\n                    case 1:\n                        _b.sent();\n                        return [2 /*return*/];\n                    case 2: return [3 /*break*/, 4];\n                    case 3:\n                        this.createComment();\n                        _b.label = 4;\n                    case 4:\n                        if (activeComment instanceof commentNode_1.CommentNode) {\n                            activeComment.editComment();\n                        }\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    ReviewZoneWidget.prototype.createComment = function () {\n        return tslib_1.__awaiter(this, void 0, Promise, function () {\n            var newCommentThread, lineNumber, isReply, e_4;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 5, , 6]);\n                        if (this._commentEditor.getModel().getValueLength() === 0) {\n                            return [2 /*return*/];\n                        }\n                        if (!this._commentGlyph) {\n                            return [2 /*return*/];\n                        }\n                        newCommentThread = void 0;\n                        lineNumber = this._commentGlyph.getPosition().position.lineNumber;\n                        isReply = this._commentThread.threadId !== null;\n                        if (!isReply) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.commentService.replyToCommentThread(this._owner, this.editor.getModel().uri, new range_1.Range(lineNumber, 1, lineNumber, 1), this._commentThread, this._commentEditor.getValue())];\n                    case 1:\n                        newCommentThread = _a.sent();\n                        return [3 /*break*/, 4];\n                    case 2: return [4 /*yield*/, this.commentService.createNewCommentThread(this._owner, this.editor.getModel().uri, new range_1.Range(lineNumber, 1, lineNumber, 1), this._commentEditor.getValue())];\n                    case 3:\n                        newCommentThread = _a.sent();\n                        if (newCommentThread) {\n                            this.createReplyButton();\n                        }\n                        _a.label = 4;\n                    case 4:\n                        if (newCommentThread) {\n                            this._commentEditor.setValue('');\n                            this._pendingComment = '';\n                            if (dom.hasClass(this._commentForm, 'expand')) {\n                                dom.removeClass(this._commentForm, 'expand');\n                            }\n                            this._commentEditor.getDomNode().style.outline = '';\n                            this._error.textContent = '';\n                            dom.addClass(this._error, 'hidden');\n                            this.update(newCommentThread);\n                            if (!isReply) {\n                                this._onDidCreateThread.fire(this);\n                            }\n                        }\n                        return [3 /*break*/, 6];\n                    case 5:\n                        e_4 = _a.sent();\n                        this._error.textContent = e_4.message\n                            ? nls.localize('commentCreationError', \"Adding a comment failed: {0}.\", e_4.message)\n                            : nls.localize('commentCreationDefaultError', \"Adding a comment failed. Please try again or report an issue with the extension if the problem persists.\");\n                        this._commentEditor.getDomNode().style.outline = \"1px solid \" + this.themeService.getTheme().getColor(colorRegistry_1.inputValidationErrorBorder);\n                        dom.removeClass(this._error, 'hidden');\n                        return [3 /*break*/, 6];\n                    case 6: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    ReviewZoneWidget.prototype.createThreadLabel = function () {\n        var label;\n        if (this._commentThread.commentThreadHandle !== undefined) {\n            label = this._commentThread.label;\n        }\n        if (label === undefined) {\n            if (this._commentThread.comments.length) {\n                var participantsList = this._commentThread.comments.filter(arrays.uniqueFilter(function (comment) { return comment.userName; })).map(function (comment) { return \"@\" + comment.userName; }).join(', ');\n                label = nls.localize('commentThreadParticipants', \"Participants: {0}\", participantsList);\n            }\n            else {\n                label = nls.localize('startThread', \"Start discussion\");\n            }\n        }\n        this._headingLabel.innerHTML = strings.escape(label);\n        this._headingLabel.setAttribute('aria-label', label);\n    };\n    ReviewZoneWidget.prototype.expandReplyArea = function () {\n        if (!dom.hasClass(this._commentForm, 'expand')) {\n            dom.addClass(this._commentForm, 'expand');\n            this._commentEditor.focus();\n        }\n    };\n    ReviewZoneWidget.prototype.createReplyButton = function () {\n        var _this = this;\n        this._reviewThreadReplyButton = dom.append(this._commentForm, dom.$('button.review-thread-reply-button'));\n        if (this._commentThread.commentThreadHandle !== undefined) {\n            // this._reviewThreadReplyButton.title = (this._commentThread as modes.CommentThread2).acceptInputCommands.title;\n        }\n        else {\n            this._reviewThreadReplyButton.title = nls.localize('reply', \"Reply...\");\n        }\n        this._reviewThreadReplyButton.textContent = nls.localize('reply', \"Reply...\");\n        // bind click/escape actions for reviewThreadReplyButton and textArea\n        this._disposables.push(dom.addDisposableListener(this._reviewThreadReplyButton, 'click', function (_) { return _this.expandReplyArea(); }));\n        this._disposables.push(dom.addDisposableListener(this._reviewThreadReplyButton, 'focus', function (_) { return _this.expandReplyArea(); }));\n        this._commentEditor.onDidBlurEditorWidget(function () {\n            if (_this._commentEditor.getModel().getValueLength() === 0 && dom.hasClass(_this._commentForm, 'expand')) {\n                dom.removeClass(_this._commentForm, 'expand');\n            }\n        });\n    };\n    ReviewZoneWidget.prototype._refresh = function () {\n        if (!this._isCollapsed && this._bodyElement) {\n            var dimensions = dom.getClientArea(this._bodyElement);\n            var headHeight = Math.ceil(this.editor.getConfiguration().lineHeight * 1.2);\n            var lineHeight = this.editor.getConfiguration().lineHeight;\n            var arrowHeight = Math.round(lineHeight / 3);\n            var frameThickness = Math.round(lineHeight / 9) * 2;\n            var computedLinesNumber = Math.ceil((headHeight + dimensions.height + arrowHeight + frameThickness + 8 /** margin bottom to avoid margin collapse */) / lineHeight);\n            this._relayout(computedLinesNumber);\n        }\n    };\n    ReviewZoneWidget.prototype.setCommentEditorDecorations = function () {\n        var model = this._commentEditor && this._commentEditor.getModel();\n        if (model) {\n            var valueLength = model.getValueLength();\n            var hasExistingComments = this._commentThread.comments.length > 0;\n            var placeholder = valueLength > 0\n                ? ''\n                : hasExistingComments\n                    ? nls.localize('reply', \"Reply...\")\n                    : nls.localize('newComment', \"Type a new comment\");\n            var decorations = [{\n                    range: {\n                        startLineNumber: 0,\n                        endLineNumber: 0,\n                        startColumn: 0,\n                        endColumn: 1\n                    },\n                    renderOptions: {\n                        after: {\n                            contentText: placeholder,\n                            color: \"\" + colorRegistry_1.transparent(colorRegistry_1.editorForeground, 0.4)(this.themeService.getTheme())\n                        }\n                    }\n                }];\n            this._commentEditor.setDecorations(exports.COMMENTEDITOR_DECORATION_KEY, decorations);\n        }\n    };\n    ReviewZoneWidget.prototype.onEditorMouseDown = function (e) {\n        this.mouseDownInfo = null;\n        var range = e.target.range;\n        if (!range) {\n            return;\n        }\n        if (!e.event.leftButton) {\n            return;\n        }\n        if (e.target.type !== editorBrowser_1.MouseTargetType.GUTTER_LINE_DECORATIONS) {\n            return;\n        }\n        var data = e.target.detail;\n        var gutterOffsetX = data.offsetX - data.glyphMarginWidth - data.lineNumbersWidth - data.glyphMarginLeft;\n        // don't collide with folding and git decorations\n        if (gutterOffsetX > 14) {\n            return;\n        }\n        this.mouseDownInfo = { lineNumber: range.startLineNumber };\n    };\n    ReviewZoneWidget.prototype.onEditorMouseUp = function (e) {\n        if (!this.mouseDownInfo) {\n            return;\n        }\n        var lineNumber = this.mouseDownInfo.lineNumber;\n        this.mouseDownInfo = null;\n        var range = e.target.range;\n        if (!range || range.startLineNumber !== lineNumber) {\n            return;\n        }\n        if (e.target.type !== editorBrowser_1.MouseTargetType.GUTTER_LINE_DECORATIONS) {\n            return;\n        }\n        if (!e.target.element) {\n            return;\n        }\n        if (this._commentGlyph && this._commentGlyph.getPosition().position.lineNumber !== lineNumber) {\n            return;\n        }\n        if (e.target.element.className.indexOf('comment-thread') >= 0) {\n            this.toggleExpand(lineNumber);\n        }\n    };\n    ReviewZoneWidget.prototype._applyTheme = function (theme) {\n        var borderColor = theme.getColor(referencesWidget_1.peekViewBorder) || color_1.Color.transparent;\n        this.style({\n            arrowColor: borderColor,\n            frameColor: borderColor\n        });\n        var content = [];\n        var linkColor = theme.getColor(colorRegistry_1.textLinkForeground);\n        if (linkColor) {\n            content.push(\".monaco-editor .review-widget .body .comment-body a { color: \" + linkColor + \" }\");\n        }\n        var linkActiveColor = theme.getColor(colorRegistry_1.textLinkActiveForeground);\n        if (linkActiveColor) {\n            content.push(\".monaco-editor .review-widget .body .comment-body a:hover, a:active { color: \" + linkActiveColor + \" }\");\n        }\n        var focusColor = theme.getColor(colorRegistry_1.focusBorder);\n        if (focusColor) {\n            content.push(\".monaco-editor .review-widget .body .comment-body a:focus { outline: 1px solid \" + focusColor + \"; }\");\n            content.push(\".monaco-editor .review-widget .body .monaco-editor.focused { outline: 1px solid \" + focusColor + \"; }\");\n        }\n        var blockQuoteBackground = theme.getColor(colorRegistry_1.textBlockQuoteBackground);\n        if (blockQuoteBackground) {\n            content.push(\".monaco-editor .review-widget .body .review-comment blockquote { background: \" + blockQuoteBackground + \"; }\");\n        }\n        var blockQuoteBOrder = theme.getColor(colorRegistry_1.textBlockQuoteBorder);\n        if (blockQuoteBOrder) {\n            content.push(\".monaco-editor .review-widget .body .review-comment blockquote { border-color: \" + blockQuoteBOrder + \"; }\");\n        }\n        var hcBorder = theme.getColor(colorRegistry_1.contrastBorder);\n        if (hcBorder) {\n            content.push(\".monaco-editor .review-widget .body .comment-form .review-thread-reply-button { outline-color: \" + hcBorder + \"; }\");\n            content.push(\".monaco-editor .review-widget .body .monaco-editor { outline: 1px solid \" + hcBorder + \"; }\");\n        }\n        var errorBorder = theme.getColor(colorRegistry_1.inputValidationErrorBorder);\n        if (errorBorder) {\n            content.push(\".monaco-editor .review-widget .validation-error { border: 1px solid \" + errorBorder + \"; }\");\n        }\n        var errorBackground = theme.getColor(colorRegistry_1.inputValidationErrorBackground);\n        if (errorBackground) {\n            content.push(\".monaco-editor .review-widget .validation-error { background: \" + errorBackground + \"; }\");\n        }\n        var errorForeground = theme.getColor(colorRegistry_1.inputValidationErrorForeground);\n        if (errorForeground) {\n            content.push(\".monaco-editor .review-widget .body .comment-form .validation-error { color: \" + errorForeground + \"; }\");\n        }\n        var fontInfo = this.editor.getConfiguration().fontInfo;\n        content.push(\".monaco-editor .review-widget .body code {\\n\\t\\t\\tfont-family: \" + fontInfo.fontFamily + \";\\n\\t\\t\\tfont-size: \" + fontInfo.fontSize + \"px;\\n\\t\\t\\tfont-weight: \" + fontInfo.fontWeight + \";\\n\\t\\t}\");\n        this._styleElement.innerHTML = content.join('\\n');\n        // Editor decorations should also be responsive to theme changes\n        this.setCommentEditorDecorations();\n    };\n    ReviewZoneWidget.prototype.show = function (rangeOrPos, heightInLines) {\n        this._isCollapsed = false;\n        _super.prototype.show.call(this, rangeOrPos, heightInLines);\n        this._refresh();\n    };\n    ReviewZoneWidget.prototype.hide = function () {\n        this._isCollapsed = true;\n        // Focus the container so that the comment editor will be blurred before it is hidden\n        this.editor.focus();\n        _super.prototype.hide.call(this);\n    };\n    ReviewZoneWidget.prototype.dispose = function () {\n        _super.prototype.dispose.call(this);\n        if (this._resizeObserver) {\n            this._resizeObserver.disconnect();\n            this._resizeObserver = null;\n        }\n        if (this._commentGlyph) {\n            this._commentGlyph.dispose();\n            this._commentGlyph = undefined;\n        }\n        this._globalToDispose.forEach(function (global) { return global.dispose(); });\n        this._submitActionsDisposables.forEach(function (local) { return local.dispose(); });\n        this._onDidClose.fire(undefined);\n    };\n    ReviewZoneWidget = tslib_1.__decorate([\n        tslib_1.__param(5, instantiation_1.IInstantiationService),\n        tslib_1.__param(6, modeService_1.IModeService),\n        tslib_1.__param(7, commands_1.ICommandService),\n        tslib_1.__param(8, modelService_1.IModelService),\n        tslib_1.__param(9, themeService_1.IThemeService),\n        tslib_1.__param(10, commentService_1.ICommentService),\n        tslib_1.__param(11, opener_1.IOpenerService)\n    ], ReviewZoneWidget);\n    return ReviewZoneWidget;\n}(zoneWidget_1.ZoneWidget));\nexports.ReviewZoneWidget = ReviewZoneWidget;\n",{"version":3,"file":"/home/coding/workspace/lib/vscode/src/vs/workbench/contrib/comments/browser/commentThreadWidget.ts","sourceRoot":"","sources":["/home/coding/workspace/lib/vscode/src/vs/workbench/contrib/comments/browser/commentThreadWidget.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as nls from 'vs/nls';\nimport * as dom from 'vs/base/browser/dom';\nimport { ActionBar } from 'vs/base/browser/ui/actionbar/actionbar';\nimport { Button } from 'vs/base/browser/ui/button/button';\nimport { Action } from 'vs/base/common/actions';\nimport * as arrays from 'vs/base/common/arrays';\nimport { Color } from 'vs/base/common/color';\nimport { Emitter, Event } from 'vs/base/common/event';\nimport { IDisposable, dispose } from 'vs/base/common/lifecycle';\nimport * as strings from 'vs/base/common/strings';\nimport { ICodeEditor, IEditorMouseEvent, MouseTargetType } from 'vs/editor/browser/editorBrowser';\nimport * as modes from 'vs/editor/common/modes';\nimport { peekViewBorder } from 'vs/editor/contrib/referenceSearch/referencesWidget';\nimport { ZoneWidget } from 'vs/editor/contrib/zoneWidget/zoneWidget';\nimport { attachButtonStyler } from 'vs/platform/theme/common/styler';\nimport { ITheme, IThemeService } from 'vs/platform/theme/common/themeService';\nimport { CommentGlyphWidget } from 'vs/workbench/contrib/comments/browser/commentGlyphWidget';\nimport { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';\nimport { IModelService } from 'vs/editor/common/services/modelService';\nimport { SimpleCommentEditor } from './simpleCommentEditor';\nimport { URI } from 'vs/base/common/uri';\nimport { transparent, editorForeground, textLinkActiveForeground, textLinkForeground, focusBorder, textBlockQuoteBackground, textBlockQuoteBorder, contrastBorder, inputValidationErrorBorder, inputValidationErrorBackground, inputValidationErrorForeground } from 'vs/platform/theme/common/colorRegistry';\nimport { IModeService } from 'vs/editor/common/services/modeService';\nimport { ICommentService } from 'vs/workbench/contrib/comments/browser/commentService';\nimport { Range, IRange } from 'vs/editor/common/core/range';\nimport { IPosition } from 'vs/editor/common/core/position';\nimport { IOpenerService } from 'vs/platform/opener/common/opener';\nimport { MarkdownRenderer } from 'vs/editor/contrib/markdown/markdownRenderer';\nimport { IMarginData } from 'vs/editor/browser/controller/mouseTarget';\nimport { CommentNode } from 'vs/workbench/contrib/comments/browser/commentNode';\nimport { ITextModel } from 'vs/editor/common/model';\nimport { ICommandService } from 'vs/platform/commands/common/commands';\nimport { generateUuid } from 'vs/base/common/uuid';\nimport { ICommentThreadWidget } from 'vs/workbench/contrib/comments/common/commentThreadWidget';\nimport { withNullAsUndefined } from 'vs/base/common/types';\n\nexport const COMMENTEDITOR_DECORATION_KEY = 'commenteditordecoration';\nconst COLLAPSE_ACTION_CLASS = 'expand-review-action octicon octicon-x';\nconst COMMENT_SCHEME = 'comment';\n\n\nlet INMEM_MODEL_ID = 0;\n\nexport class ReviewZoneWidget extends ZoneWidget implements ICommentThreadWidget {\n\tprivate _headElement: HTMLElement;\n\tprotected _headingLabel: HTMLElement;\n\tprotected _actionbarWidget: ActionBar;\n\tprivate _bodyElement: HTMLElement;\n\tprivate _parentEditor: ICodeEditor;\n\tprivate _commentEditor: ICodeEditor;\n\tprivate _commentsElement: HTMLElement;\n\tprivate _commentElements: CommentNode[];\n\tprivate _commentForm: HTMLElement;\n\tprivate _reviewThreadReplyButton: HTMLElement;\n\tprivate _resizeObserver: any;\n\tprivate _onDidClose = new Emitter<ReviewZoneWidget | undefined>();\n\tprivate _onDidCreateThread = new Emitter<ReviewZoneWidget>();\n\tprivate _isCollapsed: boolean;\n\tprivate _collapseAction: Action;\n\tprivate _commentGlyph?: CommentGlyphWidget;\n\tprivate _submitActionsDisposables: IDisposable[];\n\tprivate _globalToDispose: IDisposable[];\n\tprivate _markdownRenderer: MarkdownRenderer;\n\tprivate _styleElement: HTMLStyleElement;\n\tprivate _formActions: HTMLElement | null;\n\tprivate _error: HTMLElement;\n\n\tpublic get owner(): string {\n\t\treturn this._owner;\n\t}\n\tpublic get commentThread(): modes.CommentThread {\n\t\treturn this._commentThread;\n\t}\n\n\tpublic get extensionId(): string | undefined {\n\t\treturn this._commentThread.extensionId;\n\t}\n\n\tpublic get draftMode(): modes.DraftMode | undefined {\n\t\treturn this._draftMode;\n\t}\n\n\tconstructor(\n\t\teditor: ICodeEditor,\n\t\tprivate _owner: string,\n\t\tprivate _commentThread: modes.CommentThread | modes.CommentThread2,\n\t\tprivate _pendingComment: string,\n\t\tprivate _draftMode: modes.DraftMode | undefined,\n\t\t@IInstantiationService private instantiationService: IInstantiationService,\n\t\t@IModeService private modeService: IModeService,\n\t\t@ICommandService private commandService: ICommandService,\n\t\t@IModelService private modelService: IModelService,\n\t\t@IThemeService private themeService: IThemeService,\n\t\t@ICommentService private commentService: ICommentService,\n\t\t@IOpenerService private openerService: IOpenerService\n\t) {\n\t\tsuper(editor, { keepEditorSelection: true });\n\t\tthis._resizeObserver = null;\n\t\tthis._isCollapsed = _commentThread.collapsibleState !== modes.CommentThreadCollapsibleState.Expanded;\n\t\tthis._globalToDispose = [];\n\t\tthis._submitActionsDisposables = [];\n\t\tthis._formActions = null;\n\t\tthis.create();\n\n\t\tthis._styleElement = dom.createStyleSheet(this.domNode);\n\t\tthis._globalToDispose.push(this.themeService.onThemeChange(this._applyTheme, this));\n\t\tthis._globalToDispose.push(this.editor.onDidChangeConfiguration(e => {\n\t\t\tif (e.fontInfo) {\n\t\t\t\tthis._applyTheme(this.themeService.getTheme());\n\t\t\t}\n\t\t}));\n\t\tthis._applyTheme(this.themeService.getTheme());\n\n\t\tthis._markdownRenderer = new MarkdownRenderer(editor, this.modeService, this.openerService);\n\t\tthis._parentEditor = editor;\n\t}\n\n\tpublic get onDidClose(): Event<ReviewZoneWidget | undefined> {\n\t\treturn this._onDidClose.event;\n\t}\n\n\tpublic get onDidCreateThread(): Event<ReviewZoneWidget> {\n\t\treturn this._onDidCreateThread.event;\n\t}\n\n\tpublic getPosition(): IPosition | undefined {\n\t\tif (this.position) {\n\t\t\treturn this.position;\n\t\t}\n\n\t\tif (this._commentGlyph) {\n\t\t\treturn withNullAsUndefined(this._commentGlyph.getPosition().position);\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tprotected revealLine(lineNumber: number) {\n\t\t// we don't do anything here as we always do the reveal ourselves.\n\t}\n\n\tpublic reveal(commentId?: string) {\n\t\tif (this._isCollapsed) {\n\t\t\tthis.show({ lineNumber: this._commentThread.range.startLineNumber, column: 1 }, 2);\n\t\t}\n\n\t\tif (commentId) {\n\t\t\tlet height = this.editor.getLayoutInfo().height;\n\t\t\tlet matchedNode = this._commentElements.filter(commentNode => commentNode.comment.commentId === commentId);\n\t\t\tif (matchedNode && matchedNode.length) {\n\t\t\t\tconst commentThreadCoords = dom.getDomNodePagePosition(this._commentElements[0].domNode);\n\t\t\t\tconst commentCoords = dom.getDomNodePagePosition(matchedNode[0].domNode);\n\n\t\t\t\tthis.editor.setScrollTop(this.editor.getTopForLineNumber(this._commentThread.range.startLineNumber) - height / 2 + commentCoords.top - commentThreadCoords.top);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tthis.editor.revealRangeInCenter(this._commentThread.range);\n\t}\n\n\tpublic getPendingComment(): string | null {\n\t\tif (this._commentEditor) {\n\t\t\tlet model = this._commentEditor.getModel();\n\n\t\t\tif (model && model.getValueLength() > 0) { // checking length is cheap\n\t\t\t\treturn model.getValue();\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprotected _fillContainer(container: HTMLElement): void {\n\t\tthis.setCssClass('review-widget');\n\t\tthis._headElement = <HTMLDivElement>dom.$('.head');\n\t\tcontainer.appendChild(this._headElement);\n\t\tthis._fillHead(this._headElement);\n\n\t\tthis._bodyElement = <HTMLDivElement>dom.$('.body');\n\t\tcontainer.appendChild(this._bodyElement);\n\n\t\tdom.addDisposableListener(this._bodyElement, dom.EventType.FOCUS_IN, e => {\n\t\t\tthis.commentService.setActiveCommentThread(this._commentThread);\n\t\t});\n\t}\n\n\tprotected _fillHead(container: HTMLElement): void {\n\t\tlet titleElement = dom.append(this._headElement, dom.$('.review-title'));\n\n\t\tthis._headingLabel = dom.append(titleElement, dom.$('span.filename'));\n\t\tthis.createThreadLabel();\n\n\t\tconst actionsContainer = dom.append(this._headElement, dom.$('.review-actions'));\n\t\tthis._actionbarWidget = new ActionBar(actionsContainer, {});\n\t\tthis._disposables.push(this._actionbarWidget);\n\n\t\tthis._collapseAction = new Action('review.expand', nls.localize('label.collapse', \"Collapse\"), COLLAPSE_ACTION_CLASS, true, () => this.collapse());\n\n\t\tthis._actionbarWidget.push(this._collapseAction, { label: false, icon: true });\n\t}\n\n\tpublic collapse(): Promise<void> {\n\t\tif (this._commentThread.comments.length === 0) {\n\t\t\tif ((this._commentThread as modes.CommentThread2).commentThreadHandle === undefined) {\n\t\t\t\tthis.dispose();\n\t\t\t\treturn Promise.resolve();\n\t\t\t} else {\n\t\t\t\tconst deleteCommand = (this._commentThread as modes.CommentThread2).deleteCommand;\n\t\t\t\tif (deleteCommand) {\n\t\t\t\t\treturn this.commandService.executeCommand(deleteCommand.id, ...(deleteCommand.arguments || []));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis._isCollapsed = true;\n\t\tthis.hide();\n\t\treturn Promise.resolve();\n\t}\n\n\tpublic getGlyphPosition(): number {\n\t\tif (this._commentGlyph) {\n\t\t\treturn this._commentGlyph.getPosition().position!.lineNumber;\n\t\t}\n\t\treturn 0;\n\t}\n\n\ttoggleExpand(lineNumber: number) {\n\t\tif (this._isCollapsed) {\n\t\t\tthis.show({ lineNumber: lineNumber, column: 1 }, 2);\n\t\t} else {\n\t\t\tthis.hide();\n\t\t\tif (this._commentThread === null || this._commentThread.threadId === null) {\n\t\t\t\tthis.dispose();\n\t\t\t}\n\t\t}\n\t}\n\n\tasync update(commentThread: modes.CommentThread | modes.CommentThread2) {\n\t\tconst oldCommentsLen = this._commentElements.length;\n\t\tconst newCommentsLen = commentThread.comments.length;\n\n\t\tlet commentElementsToDel: CommentNode[] = [];\n\t\tlet commentElementsToDelIndex: number[] = [];\n\t\tfor (let i = 0; i < oldCommentsLen; i++) {\n\t\t\tlet comment = this._commentElements[i].comment;\n\t\t\tlet newComment = commentThread.comments.filter(c => c.commentId === comment.commentId);\n\n\t\t\tif (newComment.length) {\n\t\t\t\tthis._commentElements[i].update(newComment[0]);\n\t\t\t} else {\n\t\t\t\tcommentElementsToDelIndex.push(i);\n\t\t\t\tcommentElementsToDel.push(this._commentElements[i]);\n\t\t\t}\n\t\t}\n\n\t\t// del removed elements\n\t\tfor (let i = commentElementsToDel.length - 1; i >= 0; i--) {\n\t\t\tthis._commentElements.splice(commentElementsToDelIndex[i], 1);\n\t\t\tthis._commentsElement.removeChild(commentElementsToDel[i].domNode);\n\t\t}\n\n\t\tlet lastCommentElement: HTMLElement | null = null;\n\t\tlet newCommentNodeList: CommentNode[] = [];\n\t\tfor (let i = newCommentsLen - 1; i >= 0; i--) {\n\t\t\tlet currentComment = commentThread.comments[i];\n\t\t\tlet oldCommentNode = this._commentElements.filter(commentNode => commentNode.comment.commentId === currentComment.commentId);\n\t\t\tif (oldCommentNode.length) {\n\t\t\t\toldCommentNode[0].update(currentComment);\n\t\t\t\tlastCommentElement = oldCommentNode[0].domNode;\n\t\t\t\tnewCommentNodeList.unshift(oldCommentNode[0]);\n\t\t\t} else {\n\t\t\t\tconst newElement = this.createNewCommentNode(currentComment);\n\n\t\t\t\tnewCommentNodeList.unshift(newElement);\n\t\t\t\tif (lastCommentElement) {\n\t\t\t\t\tthis._commentsElement.insertBefore(newElement.domNode, lastCommentElement);\n\t\t\t\t\tlastCommentElement = newElement.domNode;\n\t\t\t\t} else {\n\t\t\t\t\tthis._commentsElement.appendChild(newElement.domNode);\n\t\t\t\t\tlastCommentElement = newElement.domNode;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis._commentThread = commentThread;\n\t\tthis._commentElements = newCommentNodeList;\n\t\tthis.createThreadLabel();\n\n\t\t// Move comment glyph widget and show position if the line has changed.\n\t\tconst lineNumber = this._commentThread.range.startLineNumber;\n\t\tlet shouldMoveWidget = false;\n\t\tif (this._commentGlyph) {\n\t\t\tif (this._commentGlyph.getPosition().position!.lineNumber !== lineNumber) {\n\t\t\t\tshouldMoveWidget = true;\n\t\t\t\tthis._commentGlyph.setLineNumber(lineNumber);\n\t\t\t}\n\t\t}\n\n\t\tif (!this._reviewThreadReplyButton) {\n\t\t\tthis.createReplyButton();\n\t\t}\n\n\t\tif (shouldMoveWidget && !this._isCollapsed) {\n\t\t\tthis.show({ lineNumber, column: 1 }, 2);\n\t\t}\n\t}\n\n\tupdateDraftMode(draftMode: modes.DraftMode | undefined) {\n\t\tif (this._draftMode !== draftMode) {\n\t\t\tthis._draftMode = draftMode;\n\n\t\t\tif (this._formActions && this._commentEditor.hasModel()) {\n\t\t\t\tconst model = this._commentEditor.getModel();\n\t\t\t\tdom.clearNode(this._formActions);\n\t\t\t\tthis.createCommentWidgetActions(this._formActions, model);\n\t\t\t}\n\t\t}\n\t}\n\n\tprotected _onWidth(widthInPixel: number): void {\n\t\tthis._commentEditor.layout({ height: 5 * 18, width: widthInPixel - 54 /* margin 20px * 10 + scrollbar 14px*/ });\n\t}\n\n\tprotected _doLayout(heightInPixel: number, widthInPixel: number): void {\n\t\tthis._commentEditor.layout({ height: 5 * 18, width: widthInPixel - 54 /* margin 20px * 10 + scrollbar 14px*/ });\n\t}\n\n\tdisplay(lineNumber: number) {\n\t\tthis._commentGlyph = new CommentGlyphWidget(this.editor, lineNumber);\n\n\t\tthis._disposables.push(this.editor.onMouseDown(e => this.onEditorMouseDown(e)));\n\t\tthis._disposables.push(this.editor.onMouseUp(e => this.onEditorMouseUp(e)));\n\n\t\tlet headHeight = Math.ceil(this.editor.getConfiguration().lineHeight * 1.2);\n\t\tthis._headElement.style.height = `${headHeight}px`;\n\t\tthis._headElement.style.lineHeight = this._headElement.style.height;\n\n\t\tthis._commentsElement = dom.append(this._bodyElement, dom.$('div.comments-container'));\n\t\tthis._commentsElement.setAttribute('role', 'presentation');\n\n\t\tthis._commentElements = [];\n\t\tfor (const comment of this._commentThread.comments) {\n\t\t\tconst newCommentNode = this.createNewCommentNode(comment);\n\n\t\t\tthis._commentElements.push(newCommentNode);\n\t\t\tthis._commentsElement.appendChild(newCommentNode.domNode);\n\t\t}\n\n\t\tconst hasExistingComments = this._commentThread.comments.length > 0;\n\t\tthis._commentForm = dom.append(this._bodyElement, dom.$('.comment-form'));\n\t\tthis._commentEditor = this.instantiationService.createInstance(SimpleCommentEditor, this._commentForm, SimpleCommentEditor.getEditorOptions(), this._parentEditor, this);\n\n\t\tconst modeId = generateUuid() + '-' + (hasExistingComments ? this._commentThread.threadId : ++INMEM_MODEL_ID);\n\t\tconst params = JSON.stringify({\n\t\t\textensionId: this.extensionId,\n\t\t\tcommentThreadId: this.commentThread.threadId\n\t\t});\n\t\tconst resource = URI.parse(`${COMMENT_SCHEME}:commentinput-${modeId}.md?${params}`);\n\t\tconst model = this.modelService.createModel(this._pendingComment || '', this.modeService.createByFilepathOrFirstLine(resource.path), resource, false);\n\t\tthis._disposables.push(model);\n\t\tthis._commentEditor.setModel(model);\n\t\tthis._disposables.push(this._commentEditor);\n\t\tthis._disposables.push(this._commentEditor.getModel()!.onDidChangeContent(() => this.setCommentEditorDecorations()));\n\t\tif ((this._commentThread as modes.CommentThread2).commentThreadHandle !== undefined) {\n\t\t\tthis._disposables.push(this._commentEditor.onDidFocusEditorWidget(() => {\n\t\t\t\tlet commentThread = this._commentThread as modes.CommentThread2;\n\t\t\t\tcommentThread.input = {\n\t\t\t\t\turi: this._commentEditor.getModel()!.uri,\n\t\t\t\t\tvalue: this._commentEditor.getValue()\n\t\t\t\t};\n\t\t\t\tthis.commentService.setActiveCommentThread(this._commentThread);\n\t\t\t}));\n\n\t\t\tthis._disposables.push(this._commentEditor.getModel()!.onDidChangeContent(() => {\n\t\t\t\tlet modelContent = this._commentEditor.getValue();\n\t\t\t\tlet thread = (this._commentThread as modes.CommentThread2);\n\t\t\t\tif (thread.input && thread.input.uri === this._commentEditor.getModel()!.uri && thread.input.value !== modelContent) {\n\t\t\t\t\tlet newInput: modes.CommentInput = thread.input;\n\t\t\t\t\tnewInput.value = modelContent;\n\t\t\t\t\tthread.input = newInput;\n\t\t\t\t}\n\t\t\t}));\n\n\t\t\tthis._disposables.push((this._commentThread as modes.CommentThread2).onDidChangeInput(input => {\n\t\t\t\tlet thread = (this._commentThread as modes.CommentThread2);\n\n\t\t\t\tif (thread.input && thread.input.uri !== this._commentEditor.getModel()!.uri) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (!input) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (this._commentEditor.getValue() !== input.value) {\n\t\t\t\t\tthis._commentEditor.setValue(input.value);\n\n\t\t\t\t\tif (input.value === '') {\n\t\t\t\t\t\tthis._pendingComment = '';\n\t\t\t\t\t\tif (dom.hasClass(this._commentForm, 'expand')) {\n\t\t\t\t\t\t\tdom.removeClass(this._commentForm, 'expand');\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis._commentEditor.getDomNode()!.style.outline = '';\n\t\t\t\t\t\tthis._error.textContent = '';\n\t\t\t\t\t\tdom.addClass(this._error, 'hidden');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}));\n\n\t\t\tthis._disposables.push((this._commentThread as modes.CommentThread2).onDidChangeComments(async _ => {\n\t\t\t\tawait this.update(this._commentThread);\n\t\t\t}));\n\n\t\t\tthis._disposables.push((this._commentThread as modes.CommentThread2).onDidChangeLabel(_ => {\n\t\t\t\tthis.createThreadLabel();\n\t\t\t}));\n\t\t}\n\n\t\tthis.setCommentEditorDecorations();\n\n\t\t// Only add the additional step of clicking a reply button to expand the textarea when there are existing comments\n\t\tif (hasExistingComments) {\n\t\t\tthis.createReplyButton();\n\t\t} else {\n\t\t\tif (!dom.hasClass(this._commentForm, 'expand')) {\n\t\t\t\tdom.addClass(this._commentForm, 'expand');\n\t\t\t\tthis._commentEditor.focus();\n\t\t\t}\n\t\t}\n\n\t\tthis._error = dom.append(this._commentForm, dom.$('.validation-error.hidden'));\n\n\t\tthis._formActions = dom.append(this._commentForm, dom.$('.form-actions'));\n\t\tif ((this._commentThread as modes.CommentThread2).commentThreadHandle !== undefined) {\n\t\t\tthis.createCommentWidgetActions2(this._formActions, model);\n\n\t\t\tthis._disposables.push((this._commentThread as modes.CommentThread2).onDidChangeAcceptInputCommand(_ => {\n\t\t\t\tif (this._formActions) {\n\t\t\t\t\tdom.clearNode(this._formActions);\n\t\t\t\t\tthis.createCommentWidgetActions2(this._formActions, model);\n\t\t\t\t}\n\t\t\t}));\n\n\t\t\tthis._disposables.push((this._commentThread as modes.CommentThread2).onDidChangeAdditionalCommands(_ => {\n\t\t\t\tif (this._formActions) {\n\t\t\t\t\tdom.clearNode(this._formActions);\n\t\t\t\t\tthis.createCommentWidgetActions2(this._formActions, model);\n\t\t\t\t}\n\t\t\t}));\n\n\t\t\tthis._disposables.push((this._commentThread as modes.CommentThread2).onDidChangeRange(range => {\n\t\t\t\t// Move comment glyph widget and show position if the line has changed.\n\t\t\t\tconst lineNumber = this._commentThread.range.startLineNumber;\n\t\t\t\tlet shouldMoveWidget = false;\n\t\t\t\tif (this._commentGlyph) {\n\t\t\t\t\tif (this._commentGlyph.getPosition().position!.lineNumber !== lineNumber) {\n\t\t\t\t\t\tshouldMoveWidget = true;\n\t\t\t\t\t\tthis._commentGlyph.setLineNumber(lineNumber);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (shouldMoveWidget && !this._isCollapsed) {\n\t\t\t\t\tthis.show({ lineNumber, column: 1 }, 2);\n\t\t\t\t}\n\t\t\t}));\n\n\t\t\tthis._disposables.push((this._commentThread as modes.CommentThread2).onDidChangeCollasibleState(state => {\n\t\t\t\tif (state === modes.CommentThreadCollapsibleState.Expanded && this._isCollapsed) {\n\t\t\t\t\tconst lineNumber = this._commentThread.range.startLineNumber;\n\n\t\t\t\t\tthis.show({ lineNumber, column: 1 }, 2);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (state === modes.CommentThreadCollapsibleState.Collapsed && !this._isCollapsed) {\n\t\t\t\t\tthis.hide();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}));\n\t\t} else {\n\t\t\tthis.createCommentWidgetActions(this._formActions, model);\n\t\t}\n\n\t\tthis._resizeObserver = new MutationObserver(this._refresh.bind(this));\n\n\t\tthis._resizeObserver.observe(this._bodyElement, {\n\t\t\tattributes: true,\n\t\t\tchildList: true,\n\t\t\tcharacterData: true,\n\t\t\tsubtree: true\n\t\t});\n\n\t\tif (this._commentThread.collapsibleState === modes.CommentThreadCollapsibleState.Expanded) {\n\t\t\tthis.show({ lineNumber: lineNumber, column: 1 }, 2);\n\t\t}\n\n\t\t// If there are no existing comments, place focus on the text area. This must be done after show, which also moves focus.\n\t\tif ((this._commentThread as modes.CommentThread).reply && !this._commentThread.comments.length) {\n\t\t\tthis._commentEditor.focus();\n\t\t} else if (this._commentEditor.getModel()!.getValueLength() > 0) {\n\t\t\tif (!dom.hasClass(this._commentForm, 'expand')) {\n\t\t\t\tdom.addClass(this._commentForm, 'expand');\n\t\t\t}\n\t\t\tthis._commentEditor.focus();\n\t\t}\n\t}\n\n\tprivate handleError(e: Error) {\n\t\tthis._error.textContent = e.message;\n\t\tthis._commentEditor.getDomNode()!.style.outline = `1px solid ${this.themeService.getTheme().getColor(inputValidationErrorBorder)}`;\n\t\tdom.removeClass(this._error, 'hidden');\n\t}\n\n\tprivate getActiveComment(): CommentNode | ReviewZoneWidget {\n\t\treturn this._commentElements.filter(node => node.isEditing)[0] || this;\n\t}\n\n\tprivate createCommentWidgetActions(container: HTMLElement, model: ITextModel) {\n\t\tdispose(this._submitActionsDisposables);\n\n\t\tconst button = new Button(container);\n\t\tthis._submitActionsDisposables.push(attachButtonStyler(button, this.themeService));\n\t\tbutton.label = 'Add comment';\n\n\t\tbutton.enabled = model.getValueLength() > 0;\n\t\tthis._submitActionsDisposables.push(this._commentEditor.onDidChangeModelContent(_ => {\n\t\t\tif (this._commentEditor.getValue()) {\n\t\t\t\tbutton.enabled = true;\n\t\t\t} else {\n\t\t\t\tbutton.enabled = false;\n\t\t\t}\n\t\t}));\n\n\t\tbutton.onDidClick(async () => {\n\t\t\tthis.createComment();\n\t\t});\n\n\t\tif (this._draftMode === modes.DraftMode.NotSupported) {\n\t\t\treturn;\n\t\t}\n\n\t\tswitch (this._draftMode) {\n\t\t\tcase modes.DraftMode.InDraft:\n\t\t\t\tconst deleteDraftLabel = this.commentService.getDeleteDraftLabel(this._owner);\n\t\t\t\tif (deleteDraftLabel) {\n\t\t\t\t\tconst deletedraftButton = new Button(container);\n\t\t\t\t\tthis._submitActionsDisposables.push(attachButtonStyler(deletedraftButton, this.themeService));\n\t\t\t\t\tdeletedraftButton.label = deleteDraftLabel;\n\t\t\t\t\tdeletedraftButton.enabled = true;\n\n\t\t\t\t\tthis._disposables.push(deletedraftButton.onDidClick(async () => {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait this.commentService.deleteDraft(this._owner, this.editor.getModel()!.uri);\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\tthis.handleError(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t}\n\n\t\t\t\tconst submitDraftLabel = this.commentService.getFinishDraftLabel(this._owner);\n\t\t\t\tif (submitDraftLabel) {\n\t\t\t\t\tconst submitdraftButton = new Button(container);\n\t\t\t\t\tthis._submitActionsDisposables.push(attachButtonStyler(submitdraftButton, this.themeService));\n\t\t\t\t\tsubmitdraftButton.label = this.commentService.getFinishDraftLabel(this._owner)!;\n\t\t\t\t\tsubmitdraftButton.enabled = true;\n\n\t\t\t\t\tsubmitdraftButton.onDidClick(async () => {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tif (this._commentEditor.getValue()) {\n\t\t\t\t\t\t\t\tawait this.createComment();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tawait this.commentService.finishDraft(this._owner, this.editor.getModel()!.uri);\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\tthis.handleError(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\t\t\tcase modes.DraftMode.NotInDraft:\n\t\t\t\tconst startDraftLabel = this.commentService.getStartDraftLabel(this._owner);\n\t\t\t\tif (startDraftLabel) {\n\t\t\t\t\tconst draftButton = new Button(container);\n\t\t\t\t\tthis._disposables.push(attachButtonStyler(draftButton, this.themeService));\n\t\t\t\t\tdraftButton.label = this.commentService.getStartDraftLabel(this._owner)!;\n\n\t\t\t\t\tdraftButton.enabled = model.getValueLength() > 0;\n\t\t\t\t\tthis._submitActionsDisposables.push(this._commentEditor.onDidChangeModelContent(_ => {\n\t\t\t\t\t\tif (this._commentEditor.getValue()) {\n\t\t\t\t\t\t\tdraftButton.enabled = true;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tdraftButton.enabled = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\n\t\t\t\t\tthis._disposables.push(draftButton.onDidClick(async () => {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait this.commentService.startDraft(this._owner, this.editor.getModel()!.uri);\n\t\t\t\t\t\t\tawait this.createComment();\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\tthis.handleError(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\t/**\n\t * Command based actions.\n\t */\n\tprivate createCommentWidgetActions2(container: HTMLElement, model: ITextModel) {\n\t\tlet commentThread = this._commentThread as modes.CommentThread2;\n\n\t\tconst { acceptInputCommand } = commentThread;\n\t\tif (acceptInputCommand) {\n\t\t\tconst button = new Button(container);\n\t\t\tthis._disposables.push(attachButtonStyler(button, this.themeService));\n\n\t\t\tbutton.label = acceptInputCommand.title;\n\t\t\tthis._disposables.push(button.onDidClick(async () => {\n\t\t\t\tcommentThread.input = {\n\t\t\t\t\turi: this._commentEditor.getModel()!.uri,\n\t\t\t\t\tvalue: this._commentEditor.getValue()\n\t\t\t\t};\n\t\t\t\tthis.commentService.setActiveCommentThread(this._commentThread);\n\t\t\t\tawait this.commandService.executeCommand(acceptInputCommand.id, ...(acceptInputCommand.arguments || []));\n\t\t\t}));\n\n\t\t\tbutton.enabled = model.getValueLength() > 0;\n\t\t\tthis._disposables.push(this._commentEditor.onDidChangeModelContent(_ => {\n\t\t\t\tif (this._commentEditor.getValue()) {\n\t\t\t\t\tbutton.enabled = true;\n\t\t\t\t} else {\n\t\t\t\t\tbutton.enabled = false;\n\t\t\t\t}\n\t\t\t}));\n\t\t}\n\n\t\tcommentThread.additionalCommands.reverse().forEach(command => {\n\t\t\tconst button = new Button(container);\n\t\t\tthis._disposables.push(attachButtonStyler(button, this.themeService));\n\n\t\t\tbutton.label = command.title;\n\t\t\tthis._disposables.push(button.onDidClick(async () => {\n\t\t\t\tcommentThread.input = {\n\t\t\t\t\turi: this._commentEditor.getModel()!.uri,\n\t\t\t\t\tvalue: this._commentEditor.getValue()\n\t\t\t\t};\n\t\t\t\tthis.commentService.setActiveCommentThread(this._commentThread);\n\t\t\t\tawait this.commandService.executeCommand(command.id, ...(command.arguments || []));\n\t\t\t}));\n\t\t});\n\t}\n\n\tprivate createNewCommentNode(comment: modes.Comment): CommentNode {\n\t\tlet newCommentNode = this.instantiationService.createInstance(CommentNode,\n\t\t\tthis._commentThread,\n\t\t\tcomment,\n\t\t\tthis.owner,\n\t\t\tthis.editor.getModel()!.uri,\n\t\t\tthis._parentEditor,\n\t\t\tthis,\n\t\t\tthis._markdownRenderer);\n\n\t\tthis._disposables.push(newCommentNode);\n\t\tthis._disposables.push(newCommentNode.onDidDelete(deletedNode => {\n\t\t\tconst deletedNodeId = deletedNode.comment.commentId;\n\t\t\tconst deletedElementIndex = arrays.firstIndex(this._commentElements, commentNode => commentNode.comment.commentId === deletedNodeId);\n\t\t\tif (deletedElementIndex > -1) {\n\t\t\t\tthis._commentElements.splice(deletedElementIndex, 1);\n\t\t\t}\n\n\t\t\tconst deletedCommentIndex = arrays.firstIndex(this._commentThread.comments, comment => comment.commentId === deletedNodeId);\n\t\t\tif (deletedCommentIndex > -1) {\n\t\t\t\tthis._commentThread.comments.splice(deletedCommentIndex, 1);\n\t\t\t}\n\n\t\t\tthis._commentsElement.removeChild(deletedNode.domNode);\n\t\t\tdeletedNode.dispose();\n\n\t\t\tif (this._commentThread.comments.length === 0) {\n\t\t\t\tthis.dispose();\n\t\t\t}\n\t\t}));\n\n\t\treturn newCommentNode;\n\t}\n\n\tasync submitComment(): Promise<void> {\n\t\tconst activeComment = this.getActiveComment();\n\t\tif (activeComment instanceof ReviewZoneWidget) {\n\t\t\tif ((this._commentThread as modes.CommentThread2).commentThreadHandle !== undefined) {\n\t\t\t\tlet commentThread = this._commentThread as modes.CommentThread2;\n\n\t\t\t\tif (commentThread.acceptInputCommand) {\n\t\t\t\t\tcommentThread.input = {\n\t\t\t\t\t\turi: this._commentEditor.getModel()!.uri,\n\t\t\t\t\t\tvalue: this._commentEditor.getValue()\n\t\t\t\t\t};\n\t\t\t\t\tthis.commentService.setActiveCommentThread(this._commentThread);\n\t\t\t\t\tlet commandId = commentThread.acceptInputCommand.id;\n\t\t\t\t\tlet args = commentThread.acceptInputCommand.arguments || [];\n\n\t\t\t\t\tawait this.commandService.executeCommand(commandId, ...args);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthis.createComment();\n\t\t\t}\n\t\t}\n\n\t\tif (activeComment instanceof CommentNode) {\n\t\t\tactiveComment.editComment();\n\t\t}\n\t}\n\n\tasync createComment(): Promise<void> {\n\t\ttry {\n\t\t\tif (this._commentEditor.getModel()!.getValueLength() === 0) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!this._commentGlyph) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet newCommentThread;\n\t\t\tconst lineNumber = this._commentGlyph.getPosition().position!.lineNumber;\n\t\t\tconst isReply = this._commentThread.threadId !== null;\n\n\n\t\t\tif (isReply) {\n\t\t\t\tnewCommentThread = await this.commentService.replyToCommentThread(\n\t\t\t\t\tthis._owner,\n\t\t\t\t\tthis.editor.getModel()!.uri,\n\t\t\t\t\tnew Range(lineNumber, 1, lineNumber, 1),\n\t\t\t\t\tthis._commentThread,\n\t\t\t\t\tthis._commentEditor.getValue()\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tnewCommentThread = await this.commentService.createNewCommentThread(\n\t\t\t\t\tthis._owner,\n\t\t\t\t\tthis.editor.getModel()!.uri,\n\t\t\t\t\tnew Range(lineNumber, 1, lineNumber, 1),\n\t\t\t\t\tthis._commentEditor.getValue()\n\t\t\t\t);\n\n\t\t\t\tif (newCommentThread) {\n\t\t\t\t\tthis.createReplyButton();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (newCommentThread) {\n\t\t\t\tthis._commentEditor.setValue('');\n\t\t\t\tthis._pendingComment = '';\n\t\t\t\tif (dom.hasClass(this._commentForm, 'expand')) {\n\t\t\t\t\tdom.removeClass(this._commentForm, 'expand');\n\t\t\t\t}\n\t\t\t\tthis._commentEditor.getDomNode()!.style.outline = '';\n\t\t\t\tthis._error.textContent = '';\n\t\t\t\tdom.addClass(this._error, 'hidden');\n\t\t\t\tthis.update(newCommentThread);\n\n\t\t\t\tif (!isReply) {\n\t\t\t\t\tthis._onDidCreateThread.fire(this);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tthis._error.textContent = e.message\n\t\t\t\t? nls.localize('commentCreationError', \"Adding a comment failed: {0}.\", e.message)\n\t\t\t\t: nls.localize('commentCreationDefaultError', \"Adding a comment failed. Please try again or report an issue with the extension if the problem persists.\");\n\t\t\tthis._commentEditor.getDomNode()!.style.outline = `1px solid ${this.themeService.getTheme().getColor(inputValidationErrorBorder)}`;\n\t\t\tdom.removeClass(this._error, 'hidden');\n\t\t}\n\t}\n\n\tprivate createThreadLabel() {\n\t\tlet label: string | undefined;\n\t\tif ((this._commentThread as modes.CommentThread2).commentThreadHandle !== undefined) {\n\t\t\tlabel = (this._commentThread as modes.CommentThread2).label;\n\t\t}\n\n\t\tif (label === undefined) {\n\t\t\tif (this._commentThread.comments.length) {\n\t\t\t\tconst participantsList = this._commentThread.comments.filter(arrays.uniqueFilter(comment => comment.userName)).map(comment => `@${comment.userName}`).join(', ');\n\t\t\t\tlabel = nls.localize('commentThreadParticipants', \"Participants: {0}\", participantsList);\n\t\t\t} else {\n\t\t\t\tlabel = nls.localize('startThread', \"Start discussion\");\n\t\t\t}\n\t\t}\n\n\t\tthis._headingLabel.innerHTML = strings.escape(label);\n\t\tthis._headingLabel.setAttribute('aria-label', label);\n\t}\n\n\tprivate expandReplyArea() {\n\t\tif (!dom.hasClass(this._commentForm, 'expand')) {\n\t\t\tdom.addClass(this._commentForm, 'expand');\n\t\t\tthis._commentEditor.focus();\n\t\t}\n\t}\n\n\tprivate createReplyButton() {\n\t\tthis._reviewThreadReplyButton = <HTMLButtonElement>dom.append(this._commentForm, dom.$('button.review-thread-reply-button'));\n\t\tif ((this._commentThread as modes.CommentThread2).commentThreadHandle !== undefined) {\n\t\t\t// this._reviewThreadReplyButton.title = (this._commentThread as modes.CommentThread2).acceptInputCommands.title;\n\t\t} else {\n\t\t\tthis._reviewThreadReplyButton.title = nls.localize('reply', \"Reply...\");\n\t\t}\n\t\tthis._reviewThreadReplyButton.textContent = nls.localize('reply', \"Reply...\");\n\t\t// bind click/escape actions for reviewThreadReplyButton and textArea\n\t\tthis._disposables.push(dom.addDisposableListener(this._reviewThreadReplyButton, 'click', _ => this.expandReplyArea()));\n\t\tthis._disposables.push(dom.addDisposableListener(this._reviewThreadReplyButton, 'focus', _ => this.expandReplyArea()));\n\n\t\tthis._commentEditor.onDidBlurEditorWidget(() => {\n\t\t\tif (this._commentEditor.getModel()!.getValueLength() === 0 && dom.hasClass(this._commentForm, 'expand')) {\n\t\t\t\tdom.removeClass(this._commentForm, 'expand');\n\t\t\t}\n\t\t});\n\t}\n\n\t_refresh() {\n\t\tif (!this._isCollapsed && this._bodyElement) {\n\t\t\tlet dimensions = dom.getClientArea(this._bodyElement);\n\t\t\tconst headHeight = Math.ceil(this.editor.getConfiguration().lineHeight * 1.2);\n\t\t\tconst lineHeight = this.editor.getConfiguration().lineHeight;\n\t\t\tconst arrowHeight = Math.round(lineHeight / 3);\n\t\t\tconst frameThickness = Math.round(lineHeight / 9) * 2;\n\n\t\t\tconst computedLinesNumber = Math.ceil((headHeight + dimensions.height + arrowHeight + frameThickness + 8 /** margin bottom to avoid margin collapse */) / lineHeight);\n\t\t\tthis._relayout(computedLinesNumber);\n\t\t}\n\t}\n\n\tprivate setCommentEditorDecorations() {\n\t\tconst model = this._commentEditor && this._commentEditor.getModel();\n\t\tif (model) {\n\t\t\tconst valueLength = model.getValueLength();\n\t\t\tconst hasExistingComments = this._commentThread.comments.length > 0;\n\t\t\tconst placeholder = valueLength > 0\n\t\t\t\t? ''\n\t\t\t\t: hasExistingComments\n\t\t\t\t\t? nls.localize('reply', \"Reply...\")\n\t\t\t\t\t: nls.localize('newComment', \"Type a new comment\");\n\t\t\tconst decorations = [{\n\t\t\t\trange: {\n\t\t\t\t\tstartLineNumber: 0,\n\t\t\t\t\tendLineNumber: 0,\n\t\t\t\t\tstartColumn: 0,\n\t\t\t\t\tendColumn: 1\n\t\t\t\t},\n\t\t\t\trenderOptions: {\n\t\t\t\t\tafter: {\n\t\t\t\t\t\tcontentText: placeholder,\n\t\t\t\t\t\tcolor: `${transparent(editorForeground, 0.4)(this.themeService.getTheme())}`\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}];\n\n\t\t\tthis._commentEditor.setDecorations(COMMENTEDITOR_DECORATION_KEY, decorations);\n\t\t}\n\t}\n\n\tprivate mouseDownInfo: { lineNumber: number } | null;\n\n\tprivate onEditorMouseDown(e: IEditorMouseEvent): void {\n\t\tthis.mouseDownInfo = null;\n\n\t\tconst range = e.target.range;\n\n\t\tif (!range) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!e.event.leftButton) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (e.target.type !== MouseTargetType.GUTTER_LINE_DECORATIONS) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst data = e.target.detail as IMarginData;\n\t\tconst gutterOffsetX = data.offsetX - data.glyphMarginWidth - data.lineNumbersWidth - data.glyphMarginLeft;\n\n\t\t// don't collide with folding and git decorations\n\t\tif (gutterOffsetX > 14) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.mouseDownInfo = { lineNumber: range.startLineNumber };\n\t}\n\n\tprivate onEditorMouseUp(e: IEditorMouseEvent): void {\n\t\tif (!this.mouseDownInfo) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst { lineNumber } = this.mouseDownInfo;\n\t\tthis.mouseDownInfo = null;\n\n\t\tconst range = e.target.range;\n\n\t\tif (!range || range.startLineNumber !== lineNumber) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (e.target.type !== MouseTargetType.GUTTER_LINE_DECORATIONS) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!e.target.element) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._commentGlyph && this._commentGlyph.getPosition().position!.lineNumber !== lineNumber) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (e.target.element.className.indexOf('comment-thread') >= 0) {\n\t\t\tthis.toggleExpand(lineNumber);\n\t\t}\n\t}\n\n\tprivate _applyTheme(theme: ITheme) {\n\t\tconst borderColor = theme.getColor(peekViewBorder) || Color.transparent;\n\t\tthis.style({\n\t\t\tarrowColor: borderColor,\n\t\t\tframeColor: borderColor\n\t\t});\n\n\t\tconst content: string[] = [];\n\t\tconst linkColor = theme.getColor(textLinkForeground);\n\t\tif (linkColor) {\n\t\t\tcontent.push(`.monaco-editor .review-widget .body .comment-body a { color: ${linkColor} }`);\n\t\t}\n\n\t\tconst linkActiveColor = theme.getColor(textLinkActiveForeground);\n\t\tif (linkActiveColor) {\n\t\t\tcontent.push(`.monaco-editor .review-widget .body .comment-body a:hover, a:active { color: ${linkActiveColor} }`);\n\t\t}\n\n\t\tconst focusColor = theme.getColor(focusBorder);\n\t\tif (focusColor) {\n\t\t\tcontent.push(`.monaco-editor .review-widget .body .comment-body a:focus { outline: 1px solid ${focusColor}; }`);\n\t\t\tcontent.push(`.monaco-editor .review-widget .body .monaco-editor.focused { outline: 1px solid ${focusColor}; }`);\n\t\t}\n\n\t\tconst blockQuoteBackground = theme.getColor(textBlockQuoteBackground);\n\t\tif (blockQuoteBackground) {\n\t\t\tcontent.push(`.monaco-editor .review-widget .body .review-comment blockquote { background: ${blockQuoteBackground}; }`);\n\t\t}\n\n\t\tconst blockQuoteBOrder = theme.getColor(textBlockQuoteBorder);\n\t\tif (blockQuoteBOrder) {\n\t\t\tcontent.push(`.monaco-editor .review-widget .body .review-comment blockquote { border-color: ${blockQuoteBOrder}; }`);\n\t\t}\n\n\t\tconst hcBorder = theme.getColor(contrastBorder);\n\t\tif (hcBorder) {\n\t\t\tcontent.push(`.monaco-editor .review-widget .body .comment-form .review-thread-reply-button { outline-color: ${hcBorder}; }`);\n\t\t\tcontent.push(`.monaco-editor .review-widget .body .monaco-editor { outline: 1px solid ${hcBorder}; }`);\n\t\t}\n\n\t\tconst errorBorder = theme.getColor(inputValidationErrorBorder);\n\t\tif (errorBorder) {\n\t\t\tcontent.push(`.monaco-editor .review-widget .validation-error { border: 1px solid ${errorBorder}; }`);\n\t\t}\n\n\t\tconst errorBackground = theme.getColor(inputValidationErrorBackground);\n\t\tif (errorBackground) {\n\t\t\tcontent.push(`.monaco-editor .review-widget .validation-error { background: ${errorBackground}; }`);\n\t\t}\n\n\t\tconst errorForeground = theme.getColor(inputValidationErrorForeground);\n\t\tif (errorForeground) {\n\t\t\tcontent.push(`.monaco-editor .review-widget .body .comment-form .validation-error { color: ${errorForeground}; }`);\n\t\t}\n\n\t\tconst fontInfo = this.editor.getConfiguration().fontInfo;\n\t\tcontent.push(`.monaco-editor .review-widget .body code {\n\t\t\tfont-family: ${fontInfo.fontFamily};\n\t\t\tfont-size: ${fontInfo.fontSize}px;\n\t\t\tfont-weight: ${fontInfo.fontWeight};\n\t\t}`);\n\n\t\tthis._styleElement.innerHTML = content.join('\\n');\n\n\t\t// Editor decorations should also be responsive to theme changes\n\t\tthis.setCommentEditorDecorations();\n\t}\n\n\tshow(rangeOrPos: IRange | IPosition, heightInLines: number): void {\n\t\tthis._isCollapsed = false;\n\t\tsuper.show(rangeOrPos, heightInLines);\n\t\tthis._refresh();\n\t}\n\n\thide() {\n\t\tthis._isCollapsed = true;\n\t\t// Focus the container so that the comment editor will be blurred before it is hidden\n\t\tthis.editor.focus();\n\t\tsuper.hide();\n\t}\n\n\tdispose() {\n\t\tsuper.dispose();\n\t\tif (this._resizeObserver) {\n\t\t\tthis._resizeObserver.disconnect();\n\t\t\tthis._resizeObserver = null;\n\t\t}\n\n\t\tif (this._commentGlyph) {\n\t\t\tthis._commentGlyph.dispose();\n\t\t\tthis._commentGlyph = undefined;\n\t\t}\n\n\t\tthis._globalToDispose.forEach(global => global.dispose());\n\t\tthis._submitActionsDisposables.forEach(local => local.dispose());\n\t\tthis._onDidClose.fire(undefined);\n\t}\n}"]}]}